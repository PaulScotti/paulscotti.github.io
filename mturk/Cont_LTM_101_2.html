<!-- Paul Scotti 2017
originally modified from Tim Brady url=http://timbrady.org/turk/ensembleindivdiff/e9/ -->

<!-- Preload javascript and css files -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<script src="./Cont_LTM_101_files/jquery.min.js"></script>
<script src="./Cont_LTM_101_files/seedrandom.js"></script>
<script src="./Cont_LTM_101_files/colors.js"></script>
<script src="./Cont_LTM_101_files/TimTurkTools.js"></script>

<script src="./Cont_LTM_101_files/jcanvas.min.js"></script>

<link rel="stylesheet" type="text/css" href="./Cont_LTM_101_files/contReport.css">
<link rel="stylesheet" type="text/css" href="./Cont_LTM_101_files/showTrials.css">
<link rel="stylesheet" type="text/css" href="./Cont_LTM_101_files/experiment.css"> 
    
<script>
    
/* Options: */
var displayTime = 1000;
var isiTime = 1000;
var numTrialsPerPart = [3, 1, 1, 1];

var practiceTriTrials = [];
var triTrials = [];
var totalTrials = [];

/* Pointers for where we are in the experiment: */
var currentTrial = -1;
var currentPart = 0;
var setTo;
var setItem;

/* Generate trials: Do it the same for each subject by seeding the
   random number generator the same every time. */
function GenerateTrials() {
  Math.seedrandom('jasonhaberman');
  for (var i=0; i<numTrialsPerPart[2]/3; i++) { 
    var curMean = Math.floor(Math.random()*360);
    for (var j=0; j<3; j++) {
      triTrials.push({'mean': curMean, 
                      'type': 'color', 
                      'isPractice': 0,
                      'items': wrap([curMean-15, curMean-5, curMean+5, curMean+15])});
    }
  }
  triTrials = Shuffle(triTrials);

  for (var i=0; i<numTrialsPerPart[0]; i++) { /* Always 3 practice trials */
    var curMean = Math.floor(Math.random()*360);
    practiceTriTrials.push({'mean': curMean, 
                    'type': 'color', 
                    'isPractice': 1,
                    'items': wrap([curMean-15, curMean-5, curMean+5, curMean+15])});
  }

}

/* Start the experiment. Show the trials for either faces or emotions
   first (at random) */
function StartExperiment() {
  if (IsOnTurk() && IsTurkPreview()) {
    alert("Please accept the HIT before continuing.");
    return false;
  }
  GenerateTrials();
  ChangeToTri();

    totalTrials = [practiceTriTrials, triTrials];
    setTo = [ChangeToTri, ChangeToTri];
    setItem = [SetTri, SetTri];

  $('#instructions').hide();
  NextTrial();
}

/* Show the next trial or show the done screen if they are finished: */
function NextTrial() {
  currentTrial++;
  if (currentTrial>=numTrialsPerPart[currentPart]) {
    if (currentPart==totalTrials.length-1) {
      Done();
      return;
    } else {
      currentTrial = 0;
      currentPart++;
      setTo[currentPart]();
      if (currentPart == 2) {
        alert("Okay, time for the real experiment. You won't get feedback about how you are doing anymore. Please do your best!");
      }
    }
  }
  ShowTrial(totalTrials[currentPart][currentTrial], setItem[currentPart]);
}

/* Basic trial structure: Wait for click; then show the stimuli for this trial; 
  then delay for fixed ISI; then call ShowContinuousReport */
function ShowTrial(trialStruct, howToSet) {
  for (var i=0; i<4; i++) {
    howToSet('#item1', trialStruct.items[i], ctx);
  }
  $('#allItems').css('margin-top', -1000);
  $('#showTrial').show();
  if (currentPart < 2) {
    $('#pressKey').html('<u><font color=navy>Practice for Part ' + (currentPart+1) + ' of 2</font></u><br><br>Trial ' + (currentTrial+1) + ' of ' + numTrialsPerPart[currentPart] + ' (in this part)<br><br>Click anywhere to start this trial.');
  }  else {
    $('#pressKey').html('<u>Part ' + (currentPart-1) + ' of 2</u><br><br>Trial ' + (currentTrial+1) + ' of ' + numTrialsPerPart[currentPart] + ' (in this part)<br><br>Click anywhere to start this trial.');  
  }
  $('#pressKey').show();
  $(document).bind('click.startTrial', function(e) { 
      $(document).unbind('click.startTrial');
      setTimeout(function() {
        $('#allItems').css('margin-top', 0);
        setTimeout(function() { 
            $('#allItems').css('margin-top', -1000);
            setTimeout(function() {
              $('#showTrial').hide();
              ShowContinuousReport(trialStruct, howToSet);
            }, isiTime);
        }, displayTime);
      }, 500);
      $('#pressKey').hide();
   });
}

/* Always track the mouse */
var mouseX, mouseY;
$(function() {
  $(document).bind('mousemove.overall', function(e) {
    mouseX = e.pageX;
    mouseY = e.pageY;
  });
});

/* Handle continuous report for either emotions or faces by using a single
   image with 360 images side-by-side in it, in the style of a css sprite */
function ShowContinuousReport(trialStruct, howToSet) {
  var centerX = 300, centerY = 300;
  var ringSize = 250;
  var angleDeg = 0;
  var curError = 360;
  var startTime = new Date();
  
    $(document).bind('mousemove.curTrial', function(e) {
    var parentOffset = $('#continuousReport').offset(); 
    var relX = e.pageX - parentOffset.left - centerX;
    var relY = e.pageY - parentOffset.top - centerY;
    var curAngle = Math.atan2(relY,relX);
    angleDeg = curAngle / Math.PI * 180.0;
    angleDeg = (angleDeg < 0) ? angleDeg+360:angleDeg;
    var imgNum = Math.round(angleDeg);
    howToSet('#continuousStimulus', imgNum, ctx2);
    $('#pointer').css({'left': centerX + Math.cos(curAngle)*ringSize-9, 
                       'top': centerY + Math.sin(curAngle)*ringSize-9});
    if (trialStruct.isPractice) {
        curError = Math.min(Math.abs(angleDeg-trialStruct.mean), 
          Math.abs((angleDeg+360)-trialStruct.mean), 
          Math.abs((angleDeg-360)-trialStruct.mean));
      $('#feedbackError').html("Your error was: " + curError + " deg (aim for less than 20 deg.!)<br><br>Click to continue.");
    }
    if (e.isFakeTrigger) {
      trialStruct.startedAngle = Math.round(angleDeg);
    }
    });
  
    $(document).bind('click.curTrial', function(e) {
    trialStruct.reportedAngle = Math.round(angleDeg);
    trialStruct.rt = (new Date()) - startTime;
    $(document).unbind('click.curTrial');
    $(document).unbind('mousemove.curTrial');
    $("#continuousReport").hide();
    if (trialStruct.isPractice) {
      $('#feedbackError').html("Your error was: " + curError + " deg (aim for less than 20 deg.!)<br><br>Click to continue.");
      var imgNum = Math.round(angleDeg);
      howToSet('#feedbackReported', imgNum, ctx);
      imgNum = Math.round(trialStruct.mean);
      howToSet('#feedbackCorrect', imgNum, ctx2);
      $('#feedback').show();
      $(document).bind('click.feedback', function(e) {
        $('#feedback').hide(); 
        NextTrial();
        $(document).unbind('click.feedback');
      });
    } else {
      NextTrial();
     }
    });
  
  $("#continuousReport").show();
  e = $.Event('mousemove');
  e.pageX = mouseX;
  e.pageY = mouseY;
  e.isFakeTrigger = true;
  $(document).trigger(e);
}

/* Done with the experiment; wait for comments and for them to hit Save */
function Done() {
  $('#done').show();
}
    
/* Save the data to the server (choose what to save) */
function SaveData() {
  $('#done').children().hide();
  $('#saving').show();
  $('#assignmentId').val(GetAssignmentId());
  var newDate = new Date();
  var curID = (IsOnTurk())? GetAssignmentId() : prompt("Doesn't look like you " + 
  "are on Turk, so you're probably testing. Enter an ID to save your data with:", "id");
  d = { 
    "curID": curID,
    "curTime": newDate.today() + " @ " + newDate.timeNow(),
    "userAgent": navigator.userAgent,
    "windowWidth": $(window).width(),
    "windowHeight": $(window).height(),
    "screenWidth": screen.width,
    "screenHeight": screen.height,    
    "comments": $('#comments').val(),
    "totalTrials": totalTrials
  };
  SendToServer(curID, d);
}

/* Send the data to the server as JSON: */
function SendToServer(id, curData) {
  var dataToServer = {
    'id': id,
    'experimentName': 'EnsembleIndivDifference9',
    'curData': JSON.stringify(curData)
  }; 
  $.post("https://timbrady.org/turk/savexxx.pl",
    dataToServer,
    function(data) { 
      document.forms[0].submit();
    }
  ).fail(function(data) { 
      document.forms[0].submit();  
  });
}


function ChangeToTri() {
  $('.itemDiv').addClass("itemDivTri").addClass("arrowRight");
  $('#continuousStimulus').addClass("continuousStimulusTri").addClass("arrowRight");
	$('#feedbackCorrect').addClass("feedbackCorrectTri").addClass("arrowRightfeed");
	$('#feedbackReported').addClass("feedbackReportedTri").addClass("arrowRightfeed");
	$('#item1').addClass("item1Tri");

  $('#continuousReport').css({'background-color': '#DDDDDD'});
  $('#showTrial').css({'background-color': '#DDDDDD'});
}

function recolor(context,newR,newG,newB) {
    var imgData = context.getImageData(200, 200, item.width, item.height);
    var data = imgData.data;
    for (var i = 0; i < data.length; i += 4) {
        red = data[i + 0];
        green = data[i + 1];
        blue = data[i + 2];
        var hsv = RGBtoHSV(red, green, blue);
        var hue = hsv.h * 360;
        if (hue > 0) {
            var temp = RGBtoHSV(newR,newG,newB);
            var newRgb = HSVtoRGB(temp.h, hsv.s, hsv.v);
            data[i + 0] = newRgb.r;
            data[i + 1] = newRgb.g;
            data[i + 2] = newRgb.b;
        }
    }
    context.putImageData(imgData, 200, 200);
}
function HSVtoRGB(h, s, v) {
    var r, g, b, i, f, p, q, t;
    if (arguments.length === 1) {
        s = h.s, v = h.v, h = h.h;
    }
    i = Math.floor(h * 6);
    f = h * 6 - i;
    p = v * (1 - s);
    q = v * (1 - f * s);
    t = v * (1 - (1 - f) * s);
    switch (i % 6) {
        case 0: r = v, g = t, b = p; break;
        case 1: r = q, g = v, b = p; break;
        case 2: r = p, g = v, b = t; break;
        case 3: r = p, g = q, b = v; break;
        case 4: r = t, g = p, b = v; break;
        case 5: r = v, g = p, b = q; break;
    }
    return {
        r: Math.round(r * 255),
        g: Math.round(g * 255),
        b: Math.round(b * 255)
    };
}
function RGBtoHSV(r, g, b) {
    if (arguments.length === 1) {
        g = r.g, b = r.b, r = r.r;
    }
    var max = Math.max(r, g, b), min = Math.min(r, g, b),
        d = max - min,
        h,
        s = (max === 0 ? 0 : d / max),
        v = max / 255;

    switch (max) {
        case min: h = 0; break;
        case r: h = (g - b) + d * (g < b ? 6: 0); h /= 6 * d; break;
        case g: h = (b - r) + d * 2; h /= 6 * d; break;
        case b: h = (r - g) + d * 4; h /= 6 * d; break;
    }

    return {
        h: h,
        s: s,
        v: v
    };
}
    
function start(context,newR,newG,newB) {
    context.drawImage(img, 200, 200);
    recolor(context,newR,newG,newB);
}

function SetTri(id, deg, context) {
    deg=(deg>=360)?deg-360:deg;
    deg=(deg<0)?deg+360:deg;
    var col=colors.colors[deg];

    img.crossOrigin = "anonymous";
    img.onload = start(context,Math.round(col[0]),Math.round(col[1]),Math.round(col[2]));
    
    img.src = "https://paulscotti.github.io/mturk/Cont_LTM_101_files/objects/Object108.jpg";
}
    
/* Make sure all numbers in an array are between 0 and 360: */
function wrap(v) {
  for (var i=0; i<v.length; i++) {
    if (v[i]>360) { v[i]-=360; }
    if (v[i]<0) { v[i]+=360; }
  }
  return v;
} 

$(window).load(function () {
  $('#startExperimentButton').show();
  $('#loading').hide();
});

$(function() {
  if (navigator.userAgent.indexOf('MSIE') != -1) {
    $('body').html('Unfortunately this HIT does not work in IE. It works in Chrome, Firefox or Safari. Sorry!');
  }
});

</script>
    
<style>
.arrowRight { 
  width: 250px;
  height: 250px;
  background-image: none;
  background-color: black;
}
    
.arrowRightfeed { 
  width: 150px;
  height: 150px;
  background-image: none;
  background-color: black;
}

canvas.continuousStimulusTri {
  margin: 175px;
  background-image: url('Cont_LTM_101_files/objects/Object107.jpg');
  background-size: 250px 250px;
}


canvas.itemDivTri {
  position: absolute;
}

canvas.item1Tri {
  margin: 175px;
  background-image: url('Cont_LTM_101_files/objects/Object107.jpg');
  background-size: 250px 250px;
}

.feedbackReportedTri {
  position: absolute;
  top: 120px;
  left: 80px;
  background-image: url('Cont_LTM_101_files/objects/Object101.jpg');
  background-size: 150px 150px;
}

.feedbackCorrectTri {
  position: absolute;
  top: 120px;
  right: 80px;
  background-image: url('Cont_LTM_101_files/objects/Object107.jpg');
  background-size: 150px 150px;
}

</style>
</head>
<body style="">

<!-- Instructions: -->
<div id="instructions">
  <p>In this HIT, you will have to perform 2 separate tasks. It should take about 15-20 minutes total. Both tasks will require you to report the perceptual average of a set of items. </p>
  <p>In one part, you'll see several circles, like this:</p>
  <p align="center"><img src="./timbrady.org_files/instrucTriangles.png" width="400" border="1"></p>
  <p>Notice how the color of the circles are all slightly different. These circles will be shown briefly, and then disappear, and you'll then be asked to report what the <strong>average color</strong> of these circles was. To do so, you'll use your mouse to change the color of a new circle (moving the mouse around the circle will change the color using a color wheel). In this case, you should report that the average color was something like this:</p>
  <p align="center"><img src="./timbrady.org_files/instrucTriangles2.png" width="400" border="1"></p>
  <p>Once you've decided what the average is, you'll click your mouse to lock your answer in and move onto the next trial. <em>It is important that you report the <strong>average</strong> of <strong>all</strong> of the circles, and that you not just pick one or two circles. </em></p>
  <p>In the second part, you will perform a similiar perceptual averaging task, but instead of circles you will see emotional faces, like this:</p>
  <p align="center"><img src="./timbrady.org_files/instrucEmotions.png" width="400" border="1"></p> 
  <p>And will then have to report, with the mouse, what the <strong>average</strong> of these emotions looked like. The faces will be different emotions (sad, happy, etc) and so on one particular trial, 3 faces might be somewhat happy and one might be more sad, making the average of the faces 'mostly happy'. To report the average emotion of the faces, you'll use a circle with different emotions on it and many subtle variations between those emotions present. As you move your mouse, the emotion of the faces will change between more happy, more neutal and more sad:</p>
  <p align="center"><img src="./timbrady.org_files/instrucEmotions2.png" width="400" border="1"></p> 
	<p>You'll have to select the average emotion that you saw in the first display, and then click when you think you've come as close as possible.</p>
  <p>To start off with, we'll give you <strong>3 practice trials</strong> of each type. During the practice trials, you'll get feedback on how far off you are. <strong>An error value close to 0 is better</strong>; further from 0 means you are far off.</p> 
  <p style="text-align: center"><a href="javascript:StartExperiment()" id="startExperimentButton" style="display: inline;">Start Experiment</a><span id="loading" style="display: none;">Images still loading. Please wait. &nbsp; &nbsp; <img src="./timbrady.org_files/spinner.gif" style="width: 30px; height: 30px"></span></p>
  <!-- Consent statement at bottom: -->
  <div id="consentDiv"><p><u>Consent to Participate in Research:</u></p><p>By answering the following questions, you are participating in a study being performed by cognitive scientists in the Harvard University Psychology Department.  The purpose of this research is to examine human visual performance.</p><p>By participating you are confirming that you are over 18 years of age and have normal or corrected-to-normal vision.</p><p>If you have questions about this research, or if you would like to receive a report of this research when it is completed please contact Timothy Brady at tbrady@wjh.harvard.edu.</p><p>Your participation in this research is completely voluntary.  If you choose to participate, you may change your mind and leave the study at any time.  Refusal to participate or stopping your participation will involve no penalty or loss of benefits to which you are otherwise entitled.</p><p>You may decline to answer any or all of the following questions. Your anonymity is assured; the researchers who have requested your participation will not receive any personal information about you. </p><p>For questions, concerns, or complaints that are not being addressed by the researcher, or research-related harm contact:  Committee on the Use of Human Subjects in Research at Harvard University, 1414 Massachusetts Avenue, Second Floor, Cambridge, MA  02138. Phone: 617-496-CUHS (2847).  Email: cuhs@fas.harvard.edu</p><p>By continuing, you are confirming that you understand these instructions and conditions of participation.</p></div>
</div>

<!-- Start form here to capture comments -->
<form id="turkSubmit" action="https://www.mturk.com/mturk/externalSubmit" method="get">
<input type="hidden" name="assignmentId" id="assignmentId" value="">
<input type="hidden" name="assignmentId" id="assignmentId" value="">
<input type="submit" value="Submit" name="submitButton" id="submitButton" style="display: none">
<!-- submit to turk
 https://workersandbox.mturk.com/mturk/externalSubmit
https://www.mturk.com/mturk/externalSubmit
-->


<!-- Screen for collecting comments when they are done: -->
<div id="done"><div id="doneText">Done! Thanks!<br><br>Any comments for us? (Was it fun? Any technical difficulties?)<br><br>
<textarea name="comments" id="comments" style="width: 300px; height: 200px"></textarea><br><br>
<a href="javascript:SaveData()" id="timSubmit">Submit</a>
</div><div id="saving">Saving . . .</div></div>

<!-- Basic structure for a trial: -->  
<div id="showTrial"><div id="allItems">
<div id="item1"></div>
    <canvas id="item"  width=400 height=400></canvas></div>
    <div id="pressKey">Click anywhere to start this trial.</div></div>
    
<!-- Structure for continuous report after the trial: -->
<div id="continuousReport"> 
    <canvas id="contItem"  width=400 height=400></canvas>
    <div id="ring"></div><div id="pointer">&nbsp;</div></div>


<script>var item = document.getElementById("item");
var ctx = item.getContext("2d");
var img = new Image();
contItem = document.getElementById("contItem");
var ctx2 = contItem.getContext("2d");
var img2 = new Image();</script>
    
<!-- feedback -->
<div id="feedback"><div id="feedbackReportedText">You choose:</div><div id="feedbackReported"></div><div id="feedbackCorrectText">Correct answer:</div><div id="feedbackCorrect"></div><div id="feedbackError">Your error was: 10 deg (aim for less than 10 degrees!).<br>Click to continue.</div></div>

<!-- preload images -->
<img src="./timbrady.org_files/combinedEmotions.png" style="width: 100px; margin-left:-1000px">
</form>


</body></html>