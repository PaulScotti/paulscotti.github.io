<!-- Paul Scotti 2018
originally modified from Tim Brady http://timbrady.org/turk/ensembleindivdiff/e9/ -->

<!-- Preload javascript and css files -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<script src="./Cont_LTM_101_files/jquery.min.js"></script>
<script src="./Cont_LTM_101_files/seedrandom.js"></script>
<script src="./Cont_LTM_101_files/TimTurkTools.js"></script>
<script src="./Cont_LTM_101_files/jcanvas.min.js"></script>
<script src="./Cont_LTM_101_files/chance.js"></script>
<script src="./Cont_LTM_101_files/blockedList.js"></script>
<script src="lodash.core.js"></script> <!-- Allows _clone -->

<!-- load Firebase server javascript, we are using it for storage -->
<script src="https://www.gstatic.com/firebasejs/4.8.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.8.2/firebase-storage.js"></script>

<link rel="stylesheet" type="text/css" href="./Cont_LTM_101_files/contReport.css">
<link rel="stylesheet" type="text/css" href="./Cont_LTM_101_files/showTrials.css">
<link rel="stylesheet" type="text/css" href="./Cont_LTM_101_files/experiment.css">

</head>
<body style="">

<!-- Consent statement: -->
<div id="consentDiv"><h1>The Ohio State University Consent to Participate in Research</h1><h2>Study Title: Individual variation in attention, cognitive control, and memory</h2><h2>Researchers: Paul S. Scotti, Yoolim Hong, Julie D. Golomb, Andrew B. Leber</h2> <p><b>This is a consent form for research participation.</b> It contains important information about this study and what to expect if you decide to participate.</p><p><b>Your participation is voluntary.</b></p><p>Please consider the information carefully. Feel free to email questions to the researchers before making your decision whether or not to participate.  If you decide to participate, you will be asked to click a button below this form.</p><p><b>Purpose:</b> In this experiment, we are interested in understanding how humans are able to control their attention to focus on relevant information, and how attention is related to other cognitive abilities and traits.</p><p><b>Procedures/Tasks:</b> Your participation involves watching various visual events on a computer screen and responding to what you saw. Additionally, you may be asked to complete a survey. You will be provided with detailed written instructions at the start of each task or survey.</p><p><b>Duration:</b> The experiment is expected to take the duration listed in the HIT description, and will not exceed 60 minutes in duration. You may leave the study at any time.  If you decide to stop participating in the study, there will be no penalty to you, and you will not lose any benefits to which you are otherwise entitled.  Your decision will not affect your future relationship with The Ohio State University.</p><p><b>Risks and Benefits:</b> There is no more risk associated with participation than you would normally encounter while playing a simple video game.  Benefits include advance scientific knowledge, experiencing the research process, and learning about attention and cognitive control.</p><p><b>Confidentiality:</b> Upon completed of the HIT, your Amazon Mechanical Turk Worker ID will be made available to the experimenters. Only select lab personnel will have access to the requester Mechanical Turk site, and Worker IDs will be used only to confirm study completion, assign compensation, and, in some cases, to invite you to participate in a follow-up study.</p><p>The data that you provide in the experiment will be stored temporarily on a secure private online server or on the web-survey platform Qualtrics, then transferred to our secure lab computers. Your name or contact information will not be collected during the experiment. Only select lab personnel who have received training in human subjects protection and clearance to handle data for this project will have access to your results. We will work to make sure that no one sees your data without approval. But, because we are using the Internet, there is a chance that someone could access your online responses without permission. In some cases, this information could be used to identify you. Your data will be protected with a code to reduce the risk that other people can view the responses. However, there are rare instances when the researcher may be required to share personally identifiable information. For example, in response to a complaint about the research, officials at The University and/or regulatory oversight government agencies (National Science Foundation) may access research data.  The researcher is also required by law to report certain information to government and/or law enforcement officials (e.g., threatened violence against self or others, communicable diseases).</p><p><b>Incentives:</b> You will receive the compensation amount listed in the HIT description (based on a rate of $6/hour). If you withdraw early for any reason, your payment will be prorated to the nearest increment of 10 minutes based on a $6/hour rate, up until the amount indicated in the HIT description. If you withdraw early, please contact the researcher at scotti.5@osu.edu to ensure you receive your compensation.</p><p><b>Participant Rights:</b> You may refuse to participate in this study without penalty or loss of benefits to which you are otherwise entitled. If you are a student or employee at Ohio State, your decision will not affect your grades or employment status.</p><p>If you choose to participate in the study, you may discontinue participation at any time without penalty or loss of benefits.  By consenting below, you do not give up any personal legal rights you may have as a participant in this study.</p><p>An Institutional Review Board responsible for human subjects research at The Ohio State University reviewed this research project and found it to be acceptable, according to applicable state and federal regulations and University policies designed to protect the rights and welfare of participants in research.</p><p><b>Contacts and Questions:</b> For questions, concerns, or complaints about the study, or you feel you have been harmed as a result of study participation, you may contact either Paul Scotti at scotti.5@osu.edu or Andrew Leber at leber.30@osu.edu. For questions about your rights as a participant in this study or to discuss other study-related concerns or complaints with someone who is not part of the research team, you may contact Ms. Sandra Meadows in the Office of Responsible Research Practices at meadows.8@osu.edu.</p><p><b>Electronic consent:</b> You may print a copy of this consent form for your records. If you wish to continue with the experiment, please click the button below.<br><center><b>Clicking the button below indicates that:</b><br>You have read the above information<br>You are 18 years of age or older<br>You voluntarily agree to participate<br></p><br></center><p style="text-align: center"><a href="javascript:$('#consentDiv').hide();$('#instructions').show();document.body.scrollTop = document.documentElement.scrollTop = 0;" id="startExperimentButton" style="display: inline;">I consent to participate in this study</a></p></div>

<!-- Instructions: -->
<div id="instructions" style="display: none">
<p>In this HIT, you will memorize the colors of a variety of objects.</p>
<p>For example, one object may be a manilla envelope. Each object has single color associated with it:</p>
<p align="center"><img src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/Instruct1.png" width="400"></p>
<p>Each object will be displayed for one second, followed by a blank delay. This will repeat until you have viewed all of our objects.</p>

<p>After you have seen all of the objects, you will be tested on your memory for each object's color. A previously observed object will be presented on the screen and you will be required to move your mouse around a color wheel to select your best guess as to the original color of the object. Once you feel you have matched the correct color of the object, click using your mouse to lock in your answer and move on to the next object.</p>

<p align="center"><img src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/Instruct2.png" width="400"></p>

<p>It is important that you be as <em>precise and as accurate as possible</em> when reporting the original colors for the objects. Also note that since this is an experiment designed to study memory, we advise that you <strong>do not take any breaks after starting this study</strong>. Note that the task is supposed to be difficult! If you do not know the correct color, move your mouse around the wheel and select what feels right.</p>

<p>After you have selected your best guess, you will be asked to highlight the region of the color wheel that represents how certain you are about your answer. In other words, you will highlight a black region surrounding your best guess, and the colors contained in this highlighted portion represent the colors you think contain the original object's color. If you are 100% certain about your answer, you would not highlight any colors, and if you were completely guessing, you would highlight the entirety of the color wheel. If you believed the original color to be somewhere between orange and red, you would highlight that portion of the color wheel.</p>

<p align="center"><img src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/Instruct3.png" width="400"></p>

<p><strong>To start off with, we'll give you a few practice trials</strong>. During practice, you will see colored objects presented one at a time. Remember to memorize the colors associated with each object. After you have seen all the practice objects, you will then be asked to report the original colors of the objects.</p>

<br><p style="text-align: center"><a href="javascript:StartExperiment();document.body.scrollTop = document.documentElement.scrollTop = 0;" id="startExperimentButton" style="display: inline;">Start Experiment</a><span id="loading" style="display: none;">Images still loading. Please wait. &nbsp; &nbsp; <img src="./Cont_LTM_101_files/spinner.gif" style="width: 30px; height: 30px"></span></p>
</div>

<!-- Start form here to capture comments -->
<form name="turkSubmit" id="turkSubmit" action="https://workersandbox.mturk.com/mturk/externalSubmit" method="POST">
<input type="hidden" name="assignmentId" id="assignmentId" value="" >
<input type="hidden" name="foo" value="" >
<input type="submit" value="Submit" name="submitButton" id="submitButton" style="display: none"></form>
<!-- submit to turk
https://workersandbox.mturk.com/mturk/externalSubmit
https://www.mturk.com/mturk/externalSubmit
-->

<!-- Screen for collecting comments when they are done: -->
<div id="done"><div id="doneText">Thanks very much for your participation!<br><br>Any comments for us? (Was it fun? Any technical difficulties?)<br><br>
<textarea name="comments" id="comments" style="width: 400px; height: 300px"></textarea><br><br>
<a href="javascript:SaveData()" id="timSubmit">Click to Submit HIT</a>
</div><div id="saving">Saving . . .</div></div>

<!-- Basic structure for a trial: -->
<div id="showTrial">
<div id="fixation">+</div>
<div id="allItems">
<canvas id="item"  width=400 height=400></canvas></div></div>

<!-- Structure for continuous report after the trial: -->
<div id="continuousReport">
<canvas id="contItem"  width=600 height=600 style="position: absolute; left: 0; top: 0;"></canvas>
<canvas id="ringItem"  width=600 height=600 style="position: absolute; left: 0; top: 0;"></canvas>
<div id="pointer"></div>
<div id="popQuiz"><p>Pop quiz! What color was this object?</p></div>
</div>

<!-- feedback -->
<div id="feedback">
    <div id="feedbackReportedText">Your response:</div><canvas id="feedbackReportedTri" width=300 height=300></canvas><div id="feedbackCorrectText">Correct response:</div><canvas id="feedbackCorrectTri" width=300 height=300></canvas><div id="feedbackError">Your error was: 10 deg (aim for less than 10 degrees!).<br>Click to continue.</div></div>

<form id="survey2" style="display: none;">
    <center>
    <div id = "doneText"><p>You finished! Just a few questions before you go:<p><br><br><p>Do you think object colors were sampled randomly or do you think most objects shared approximately the same color?</p></div>
    <br><br><br><br>
    <input name="choice" type="radio" value="nope" id="surveyresponse2" /> Randomly sampled colored
    <br><br>
    <input name="choice" type="radio" value="yes" id="surveyresponse" /> Preferentially sampled colors
    <br><br><br><br>
    <a href="javascript:Survey();" id="startExperimentButton" style="display: inline;">Submit</a>
    </center>
</form>

<!-- Preload images, needs to be below divs -->
<script src="./Cont_LTM_101_files/loadimg.js"></script>

<script>
curID = (IsOnTurk())? GetAssignmentId() : prompt("You don't look like an mTurker! " +
"Enter an ID to save your data with (any number/string will do):", "id");

CheckBlockList(blockedIDs,curID);

// Initialize Firebase
var config = {
    apiKey: "AIzaSyBeD1E8RCvOck3CeWzXbg2hGURf-sSrx8A",
    authDomain: "scotti-92222.firebaseapp.com",
    databaseURL: "https://scotti-92222.firebaseio.com",
    projectId: "scotti-92222",
    storageBucket: "scotti-92222.appspot.com",
    messagingSenderId: "123079954596"
};
firebase.initializeApp(config);

/* disable context menu
document.oncontextmenu = function() {
    return false;
}*/

/* Options: */
var totalRepeats = 12;
var numTrialsPerPart = [3, 6]; // 240 trials
</script> <script src="./Cont_LTM_101_files/colors.js"> </script>

<script>
var imgWidth = 200;
var imgHeight = 200;
var displayTime = 1000;
var isiTime = 1000;
var origColors = _.clone(colors); // clone is required to create a new variable and not a pointer variable
var flippedColors = _.clone(colors).reverse();
flippedColors = flippedColors.concat(flippedColors.splice(0,180)); // shift array 180

var practiceTriTrials = [];
var triTrials = [];
var repeatTriTrials = [];
var totalTrials = [];

/* Pointers for where we are in the experiment: */
var currentTrial = -1;
var currentPart = 0;
var currentFeedTrial = -1;
var feedbackPhase = 0;
var repeat = 0;
var numRepeats = 0;
var hit = 0;
var numHits = 0;
var falseHits = 0;
var mouseClick = -1;
var randrotate = 0;
var angleDeg = 0;
var curError = 360;
var flip = 0;
var survey = 0;
var readyRepeat = 0;
var waitObject = 0;
const radius = 242;
const ringSize = 242;
const centerX = 300; const centerY = 300;

/* Randomize orderings */
Shuffle(dx.r_study);
chance1 = Chance(curID);
dx.r_study = dx.r_study.slice(0,numTrialsPerPart[1]);
dx.r_test = _.clone(dx.r_study);
dx.r_test = chance1.shuffle(dx.r_test);
chance1 = Chance(curID);
/*dx.r_pracimg = chance1.shuffle(dx.pracimg);
chance1 = Chance(curID);
/*dx.r_repeatimg = chance1.shuffle(dx.r_repeatimg);
chance1 = Chance(curID);*/
dx.r_TrialType = chance1.shuffle(dx.r_TrialType);
chance1 = Chance(curID);
dx.rep_TrialType = chance1.shuffle(dx.rep_TrialType);
chance1 = Chance(curID);

Shuffle(dx.r_repeattrial);
dx.r_repeattrial = dx.r_repeattrial.splice(dx.r_repeattrial.length-11); /*this means 12 repeats!*/

/* Setup reused image variable */
var img = new Image();
img.crossOrigin = "anonymous";

/* Setup ring image */
var ringImg = new Image();
ringImg.crossOrigin = "anonymous";
ringImg.src = $('#ring')[0].src;

/* Setting up canvas contexts */
var item = document.getElementById("item");
var ctx = item.getContext("2d");
contItem = document.getElementById("contItem");
var ctx2 = contItem.getContext("2d");
var feedbackReportedTri = document.getElementById("feedbackReportedTri");
var ctx3 = feedbackReportedTri.getContext("2d");
feedbackCorrectTri = document.getElementById("feedbackCorrectTri");
var ctx4 = feedbackCorrectTri.getContext("2d");
ringItem = document.getElementById("ringItem");
var ringctx = ringItem.getContext("2d");

/* Start by hiding pop quiz text */
$('#popQuiz').hide();

/* Generate trials: Do it the same for each subject by seeding the random number generator the same every time. */
function GenerateTrials() {
  if (curID == null) {
    curID = 'no_id';
  }
  Math.seedrandom(curID); /* Use their ID as the random seed generator, so you can trace back their trials */

  seed = Math.floor(Math.random()*360);
  seed = [seed, (seed + 90)];
  seed = [seed[0], seed[1], (seed[1] + 90)];
  seed = [seed[0], seed[1], seed[2], (seed[2] + 90)];
  wrap(seed);

  for (var i=0; i<numTrialsPerPart[1]; i++) {
    var pickSeed = dx.r_TrialType[i];
    var curMean = seed[pickSeed] + (Math.floor(Math.random()*90) - 45);
    wrap(curMean);
    let indexArr = dx.r_test;
    origTrial = indexArr.findIndex(indexArr => indexArr==dx.r_study[i]);
    triTrials.push({'mean': seed[pickSeed],
                    'seed': pickSeed,
                    'isPractice': 0,
                    'item': curMean,
                    'origTrial': origTrial});
  }
  triTrials = Shuffle(triTrials);

  for (var i=0; i<numTrialsPerPart[0]; i++) {
    var curMean = Math.floor(Math.random()*360);
    practiceTriTrials.push({'isPractice': 1,
                    'item': curMean});
  }

  for (var i=0; i<dx.rep_TrialType.length; i++) {
    var pickSeed = dx.rep_TrialType[i];
    var curMean = seed[pickSeed] + (Math.floor(Math.random()*90) - 45);
    wrap(curMean);
    repeatTriTrials.push({'mean': seed[pickSeed],
                    'seed': pickSeed,
                    'isPractice': 0,
                    'item': curMean,
                    'origTrial': dx.r_repeattrial[i]});
  }
    repeatTriTrials = Shuffle(repeatTriTrials);
}

/* Start the experiment, this function is the first to operate! */
function StartExperiment() {
  if (IsOnTurk() && IsTurkPreview()) {
    alert("Please accept the HIT before continuing.");
    return false;
  }
  GenerateTrials();

  r_totalTrials = [practiceTriTrials, triTrials];

  chance1 = Chance(curID); /* Use their ID as the random seed generator, so you can trace back their trials */
  r_totalTrials = [r_totalTrials[0], chance1.shuffle(triTrials)];

  $('#instructions').hide();
  NextTrial();
}

/* Show the next trial or show the done screen if they are finished: */
function NextTrial() {
  repeat = 0;
  if (! (readyRepeat == 1 && waitObject != 2)) {
    currentTrial++;
  }

  if (currentTrial>numTrialsPerPart[currentPart]-1) {
      alert("You will now see previously displayed objects again, one at a time. Please move your mouse around the color wheel to adjust the color of the object until it matches its original color (be as precise as possible). Then click to continue.");
      $('#showTrial').hide();
      /* Start continuous color report trials */
      NextFeedTrial();
      /* need return; otherwise the ShowTrial below executes */
      return;
  }
  if (readyRepeat == 1 && waitObject != 2) {
    ShowTrial(repeatTriTrials[numRepeats]);
  } else {
    ShowTrial(r_totalTrials[currentPart][currentTrial]);
  }
}

/* Basic trial structure: Wait for click; then show the stimuli for this trial; then delay for fixed ISI; then call ShowContinuousReport */
function ShowTrial(trialStruct) {
    if (currentTrial == Math.ceil(numTrialsPerPart[1]/2) && currentPart == 1 && readyRepeat == 0) {
        alert('You are half way through the learning phase of this experiment! Keep it up!');
    }

    img.onload = function() {
      start(ctx,trialStruct.item,200,200,imgWidth,imgHeight,flip);
    }
    if (currentPart == 0) {
        img.src = $('#' + dx.pracimg[currentTrial])[0].src;
    } else if (readyRepeat == 1 && waitObject != 2) {
        img.src = $('#' + dx.r_repeattrial[numRepeats])[0].src;
    } else {
        img.src = $('#' + dx.r_study[currentTrial])[0].src;
    }

    $('#allItems').css('margin-top', -1000);
    $('#showTrial').show();
    setTimeout(function() {
        $('#allItems').css('margin-top', 0);
        setTimeout(function() {
            $('#allItems').css('margin-top', -1000);
            setTimeout(function() {
              $('#showTrial').hide();
                if (currentPart == 0) {
                    NextTrial();
                } else {
                    if (readyRepeat == 1) {
                      if (waitObject != 1) {
                        readyRepeat = 0;
                        RepeatTrial();
                      } else {
                        waitObject = 2;
                        NextTrial();
                      }
                    } else {
                      if (dx.r_repeattrial.includes(100+currentTrial)) {
                          waitObject = Math.random()<0.5? 0 : 1;
                          if (currentTrial == numTrialsPerPart[1] - 1) { waitObject = 0; }
                          readyRepeat = 1; NextTrial();
                      } else {
                          readyRepeat = 0; NextTrial();
                      }
                    }
                }
            }, isiTime);
        }, displayTime);
    }, 500);
}

function RepeatTrial() { /* Should really be renamed abrupt-onset trial, not RepeatTrial */
  repeat = 1;
  $('#popQuiz').show();
  // alert('Pop quiz! What color was this object?');

  img.src = $('#' + dx.r_repeattrial[numRepeats])[0].src;
  ctx2.drawImage(img, 200,200,imgWidth,imgHeight);

  /*Preload color wheel, first practice trial will have randrotate=0 and flip=0*/
  ringctx.restore();
  ringctx.drawImage(ringImg,50,50,500,500);
  ringctx.save();

  ShowContinuousReport(repeatTriTrials[numRepeats]);

  /* Set starting color as grayscale */
  start(ctx2,'gray',200,200, imgWidth, imgHeight, flip);
  mouseMoved = 0;
};

/* Show the next continuous color report trial: */
function NextFeedTrial() {
  currentFeedTrial++;

  if (currentFeedTrial>numTrialsPerPart[currentPart]-1) {
    if (currentPart == 1) {
      $('showTrial').hide;
      Survey2();
      return;
    } else {
      currentFeedTrial = -1;
      currentPart++;
        alert("Okay, time for the real experiment. Please do your best to remember the colors of the subsequent objects, as you\'ll be tested on your memory for all of them by the end. Thank you and we wish you the best of luck!");
        currentTrial = -1;
        NextTrial();
        return;
    }
  }

  /*Preload color wheel, first practice trial will have randrotate=0 and flip=0*/
  ringctx.restore();
  ringctx.drawImage(ringImg,50,50,500,500);
  ringctx.save();

  if (currentFeedTrial <= 0) {
      /* Initialize first object */
      if (currentPart == 0) {
        img.src = $('#' + dx.pracimg[0])[0].src;
      } else {
        img.src = $('#' + dx.r_test[0])[0].src;
      }
  }

  ShowContinuousReport(r_totalTrials[currentPart][currentFeedTrial]);

  /* Set starting color as grayscale */
  start(ctx2,'gray',200,200, imgWidth, imgHeight, flip);
  mouseMoved = 0;
}

/* Always track the mouse */
var mouseX, mouseY;
$(function() {
  $(document).bind('mousemove.overall', function(e) {
    mouseX = e.pageX;
    mouseY = e.pageY;
  });
});

function ShowContinuousReport(trialStruct) {
  angleDeg = 0;
  curError = 360;
  var startTime = new Date();

  $(document).bind('mousemove.curTrial', function(e) {
      var parentOffset = $('#continuousReport').offset();
      var relX = e.pageX - parentOffset.left - centerX;
      var relY = e.pageY - parentOffset.top - centerY;
      var curAngle = Math.atan2(relY,relX);
      angleDeg = curAngle / Math.PI * 180.0;
      var imgNum = Math.round(wrap([angleDeg-randrotate]));
      mouseMoved = 1;
      start(ctx2,imgNum,200,200,imgWidth,imgHeight,flip);

      if (currentPart == 0) {
          img.src = $('#' + dx.pracimg[currentFeedTrial])[0].src;
      } else if (repeat == 1) {
          img.src = $('#' + dx.r_repeattrial[numRepeats])[0].src;
      } else if (survey == 0) {
          img.src = $('#' + dx.r_test[currentFeedTrial])[0].src;
      } else if (survey == 1) {
          img.src = $('#999')[0].src;
      }
      $('#pointer').css({'left': centerX + Math.cos(curAngle)*ringSize-9,
                         'top': centerY + Math.sin(curAngle)*ringSize-9});

      curError = Math.abs(imgNum-trialStruct.item);
      if (curError > 180) {
          curError = 360-curError;
      }

      if (e.isFakeTrigger) {
        trialStruct.startedAngle = Math.round(wrap([angleDeg-randrotate]));
        flip == 0? ringImg.src = $('#ring')[0].src : ringImg.src = $('#ringFlip')[0].src;
        ringctx.translate(50+500/2, 50+500/2);
        ringctx.rotate(randrotate*Math.PI/180);
        ringctx.translate(-50-500/2, -50-500/2);
        ringctx.drawImage(ringImg,50,50,500,500);
      }
  });

  $(document).bind('click.curTrial', function(e) {
      if (survey == 1) {
          explicitErr = curError;
      }

      if (mouseMoved == 0) {
          alert('Move your mouse around the circle and click to select your best guess at to the original object color. Please be as precise as possible!');
      } else {
          trialStruct.reportedAngle = Math.round(angleDeg);
          trialStruct.rt = (new Date()) - startTime;
          $(document).unbind('click.curTrial');
          $(document).unbind('mousemove.curTrial');
          $("#continuousReport").hide();
          if (currentPart == 0 && currentFeedTrial == 0) {
            alert('Cool! Now highlight the smallest range of colors you think includes the true color. This is a confidence range to inform us experimenters about how certain you are of your answer.' +
            ' Click after you\'ve highlighted colors in one circular direction, and then we\'ll do the other direction.')
          }
          ShowConfidence(trialStruct,angleDeg);
          $('#popQuiz').hide();
      }
  });

  $("#continuousReport").show(); /* Refresh the page to update same context set to new img src */
  e = $.Event('mousemove');
  e.pageX = mouseX;
  e.pageY = mouseY;
  e.isFakeTrigger = true;
  $(document).trigger(e);
}

function ShowConfidence(trialStruct,angleDeg) {
    var angleDeg2 = 0;
    var startTime = new Date();
    var startAngle = angleDeg * Math.PI / 180;
    var lastRot = 0;
    var noMore = 0;
    var diffAng = -999;

    /* Confidence report */
    $(document).bind('mousemove.curTrial', function(e) {
        var parentOffset = $('#continuousReport').offset();
        var relX = e.pageX - parentOffset.left - centerX;
        var relY = e.pageY - parentOffset.top - centerY;
        var curAngle = Math.atan2(relY,relX);
        var angleDeg2 = curAngle / Math.PI * 180.0;
        diffAng = wrap([wrap([angleDeg])-wrap([angleDeg2])])>180? wrap([wrap([angleDeg2])-wrap([angleDeg])]) : wrap([wrap([angleDeg])-wrap([angleDeg2])]);
        if (wrap([wrap([angleDeg])-wrap([angleDeg2])])<180 && noMore == 0) { /* conf is counterclockwise */
          ctx2.beginPath();
          ctx2.arc(centerX, centerY, radius, startAngle - Math.PI, curAngle, 1);
          ctx2.lineWidth = 50;
          ctx2.strokeStyle = 'white';
          ctx2.stroke();
          ctx2.beginPath();
          ctx2.arc(centerX, centerY, radius, startAngle, curAngle, 1);
          ctx2.lineWidth = 40;
          ctx2.strokeStyle = 'black';
          ctx2.stroke();
          ctx2.beginPath();
          ctx2.arc(centerX, centerY, radius, startAngle + Math.PI, curAngle, 0);
          ctx2.lineWidth = 50;
          ctx2.strokeStyle = 'white';
          ctx2.stroke();
          lastRot = 1;
        } else if (wrap([wrap([angleDeg])-wrap([angleDeg2])])>180 && noMore == 0) { /* conf is clockwise */
          ctx2.beginPath();
          ctx2.arc(centerX, centerY, radius, startAngle + Math.PI, curAngle, 0);
          ctx2.lineWidth = 50;
          ctx2.strokeStyle = 'white';
          ctx2.stroke();
          ctx2.beginPath();
          ctx2.arc(centerX, centerY, radius, startAngle, curAngle, 0);
          ctx2.lineWidth = 40;
          ctx2.strokeStyle = 'black';
          ctx2.stroke();
          ctx2.beginPath();
          ctx2.arc(centerX, centerY, radius, startAngle - Math.PI, curAngle, 1);
          ctx2.lineWidth = 50;
          ctx2.strokeStyle = 'white';
          ctx2.stroke();
          lastRot = 0;
        }
    });

    $(document).bind('click.curTrial', function(e) {
      if (currentPart == 0 && currentFeedTrial == 0 && noMore == 0) {
        if (lastRot == 0) {
          alert('Lookin\' good! Now finish your highlighting in the other circular direction. ' +
          ' Since you went clockwise so far, finish by clicking counterclockwise from your original best guess.')
        } else {
          alert('Lookin\' good! Now finish your highlighting in the other circular direction. ' +
          ' Since you went counterclockwise so far, finish by clicking clockwise from your original best guess.')
        }
      }
      ShowConfidence2(trialStruct,angleDeg,angleDeg2,diffAng,lastRot);
      noMore = 1;
    })

    $("#continuousReport").show();
    e = $.Event('mousemove');
    e.pageX = mouseX;
    e.pageY = mouseY;
    e.isFakeTrigger = true;
    $(document).trigger(e);
}

function ShowConfidence2 (trialStruct,angleDeg,angleDeg2,diffAng,lastRot) {
  var angleDeg3 = 0;
  var startTime = new Date();
  var startAngle = angleDeg * Math.PI / 180;
  var startAngle2 = angleDeg2 * Math.PI / 180;

  /* Confidence report */
  $(document).bind('mousemove.curTrial', function(e) {
      var parentOffset = $('#continuousReport').offset();
      var relX = e.pageX - parentOffset.left - centerX;
      var relY = e.pageY - parentOffset.top - centerY;
      var curAngle = Math.atan2(relY,relX);
      var angleDeg3 = curAngle / Math.PI * 180.0;
      if (wrap([wrap([angleDeg])-wrap([angleDeg3])])<180+(180-diffAng) && lastRot == 0) { /* conf is counterclockwise */
        ctx2.beginPath();
        ctx2.arc(centerX, centerY, radius, startAngle, curAngle, 1);
        ctx2.lineWidth = 40;
        ctx2.strokeStyle = 'black';
        ctx2.stroke();
        ctx2.beginPath();
        ctx2.arc(centerX, centerY, radius, startAngle + diffAng*Math.PI/180, curAngle, 0);
        ctx2.lineWidth = 50;
        ctx2.strokeStyle = 'white';
        ctx2.stroke();
      } else if (wrap([wrap([angleDeg])-wrap([angleDeg3])])>180-(180-diffAng) && lastRot == 1) { /* conf is clockwise */
        ctx2.beginPath();
        ctx2.arc(centerX, centerY, radius, startAngle, curAngle, 0);
        ctx2.lineWidth = 40;
        ctx2.strokeStyle = 'black';
        ctx2.stroke();
        ctx2.beginPath();
        ctx2.arc(centerX, centerY, radius, startAngle - diffAng*Math.PI/180, curAngle, 1);
        ctx2.lineWidth = 50;
        ctx2.strokeStyle = 'white';
        ctx2.stroke();
      }
  });

  $(document).bind('click.curTrial', function(e) {
    ctx2.clearRect(0, 0, 600, 600);
    /* Show approximate feedback: amazing! < 15, good! < 30 */
    if (trialStruct.isPractice) {
      $('#feedbackError').html("Your error was: " + Math.round(curError) + " deg (aim for less than 30 deg!)<br><br>Click to continue.");
    }
    if (curError <= 15) {
        feedText = 'Amazing!';
    } else if (curError <= 30) {
        feedText = 'Good!';
    } else {
        feedText = '...';
    }
    document.getElementById("fixation").innerHTML = feedText;
    $("#continuousReport").hide();
    $(document).unbind('click.curTrial');
    $(document).unbind('mousemove.curTrial');

    if (survey == 0) {
        if (trialStruct.isPractice) {
            $('#feedbackError').html("Your error was: " + Math.round(curError) + " deg (aim for less than 30 deg.!)<br><br>Click to continue.");

            var imgNum = Math.round(wrap([angleDeg-randrotate]));
            start(ctx3,imgNum,80,100, imgWidth, imgHeight, flip);
            var imgNum = Math.round(trialStruct.item);
            start(ctx4,imgNum,40,100, imgWidth, imgHeight, flip);

            if (currentFeedTrial+1 < numTrialsPerPart[0]) {
            img.src = $('#' + dx.pracimg[currentFeedTrial+1])[0].src;
            }
            ctx2.drawImage(img, 200,200,imgWidth,imgHeight);

            flip = Math.round(Math.random());
            randrotate = Math.floor(Math.random()*360);
            flip == 0? ringImg.src = $('#ring')[0].src : ringImg.src = $('#ringFlip')[0].src;
            ringctx.translate(50+500/2, 50+500/2);
            ringctx.rotate(randrotate*Math.PI/180);
            ringctx.translate(-50-500/2, -50-500/2);
            ringctx.drawImage(ringImg,50,50,500,500);

            $('#feedback').show();
            $(document).bind('click.feedback', function(e) {
                $('#feedback').hide();
                NextFeedTrial();
                document.getElementById("fixation").innerHTML = '+';
                $(document).unbind('click.feedback');
            });
        } else {
            $('#showTrial').show();
            if (repeat == 1) {
                img.src = $('#' + dx.r_study[currentTrial-1])[0].src;
                numRepeats++;
            } else if (currentFeedTrial < numTrialsPerPart[1]-1) {
                img.src = $('#' + dx.r_test[currentFeedTrial+1])[0].src;
            } else if (currentFeedTrial>=numTrialsPerPart[currentPart]-1) { /* this is to prepare the gray square in explicit test */
                img.src = $('#999')[0].src;
            }
            flip = Math.round(Math.random());
            randrotate = Math.floor(Math.random()*360);
            flip == 0? ringImg.src = $('#ring')[0].src : ringImg.src = $('#ringFlip')[0].src;
            ringctx.translate(50+500/2, 50+500/2);
            ringctx.rotate(randrotate*Math.PI/180);
            ringctx.translate(-50-500/2, -50-500/2);
            ringctx.drawImage(ringImg,50,50,500,500);
            setTimeout(function() {
                if (repeat == 0) { $('#showTrial').hide(); }
                repeat == 1? NextTrial() : NextFeedTrial();
                document.getElementById("fixation").innerHTML = '+';
            }, isiTime);
        }
    } else {
        completeForm();
    }

  });
}

function Survey() {
  $("#survey2").hide();
  survey = 1;

  /*Preload color wheel, first practice trial will have randrotate=0 and flip=0*/
  ringctx.restore();
  ringctx.drawImage(ringImg,50,50,500,500);
  ringctx.save();

  //alert('Please select the most frequent color you think objects appeared as throughout the experiment.')
  document.getElementById("popQuiz").innerHTML = "Please select the most frequent color you think objects appeared as throughout the experiment.";
  $('#popQuiz').show();
  ShowContinuousReport({mean: seed[0], type: "color", isPractice: 0, items: 999});

  /* Set starting color as grayscale */
  start(ctx2,'gray',200,200, imgWidth, imgHeight, flip);
  mouseMoved = 0;
}

function Survey2() {
    $("#survey2").show();
}

/* Done with the experiment; wait for comments and for them to hit Save */
function Done() {
  $('#done').show();
}

/* Choose what to save and then put it on the server */
function SaveData() {
  $('#done').children().hide();
  $('#saving').show();
  $('#assignmentId').val(GetAssignmentId());
  var newDate = new Date();
  d = {
    "curID": curID,
    "curTime": newDate.today() + " @ " + newDate.timeNow(),
    "userAgent": navigator.userAgent,
    "windowWidth": $(window).width(),
    "windowHeight": $(window).height(),
    "screenWidth": screen.width,
    "screenHeight": screen.height,
    "comments": $('#comments').val(),
    "trialTimes": timetofirstclick,
    "totalTrials": totalTrials,
    "explicitError": explicitErr,
    "explicitConfidence": explicitConf,
    "implicitResponse": implicitResp,
    "seeds": seed,
    "TestResponse": reportedcolor,
    "TestError": curError,
    "TestConfidence": confError,
    "StudyOrder": dx.r_study,
    "TestOrder": dx.r_test,
    "SeedOrder": dx.r_TrialType,
    "RepSeedOrder": dx.rep_TrialType,
    "abruptResponses": numHits,
    "abruptConfidence": falseHits
  };

    /* save to Firebase server */
    var blob = new Blob([JSON.stringify(d)], {type: "application/json"});
    var storageRef = firebase.storage().ref('data/' + curID + '.json');
    storageRef.put(blob);

    document.getElementById("saving").innerHTML = "Done!";

    document.forms[0].submit();
}

function start(context,deg,initX,initY,imgWidth,imgHeight,flip) {
    flip==0? colors=origColors : colors=flippedColors;
    if (deg == 'gray') {
        var col = [127.5,127.5,127.5];
    } else {
        deg=(deg>=360)?deg-360:deg;
        deg=(deg<0)?deg+360:deg;
        var col=colors[deg];
    }
    context.drawImage(img, initX, initY, imgWidth, imgHeight);
    recolor(context,Math.round(col[0]),Math.round(col[1]),Math.round(col[2]),initX,initY);
}
function recolor(context,newR,newG,newB,initX,initY) {
    imgData = context.getImageData(initX, initY, item.width, item.height);
    var data = imgData.data;
    for (var i = 0; i < data.length; i += 4) {
        var red = data[i];
        var green = data[i + 1];
        var blue = data[i + 2];
        if (red != 0 && red!= 255) {
            data[i] = newR;
            data[i + 1] = newG;
            data[i + 2] = newB;
        }
    }
    context.putImageData(imgData, initX, initY);
}

/* Make sure all numbers in an array are between 0 and 360: */
function wrap(v) {
  for (var i=0; i<v.length; i++) {
    if (v[i]>360) { v[i]-=360; }
    if (v[i]<0) { v[i]+=360; }
  }
  return v;
}

function completeForm() {
    if (document.getElementById("surveyresponse").checked) {
        implicitResp = 1;
    } else if (document.getElementById("surveyresponse2").checked) {
        implicitResp = 2;
    }
    //proceed only if they picked one of two options
    if (implicitResp > 0) {
        $('#instructions').hide();
        Done();
    } else {
        alert('Please select an option.');
    }
    return false;
}

$(window).load(function () {
  $('#startExperimentButton').show();
  $('#loading').hide();
});

$(function() {
  if (navigator.userAgent.indexOf('MSIE') != -1) {
    $('body').html('Unfortunately this HIT does not work in IE. It works in Chrome, Firefox or Safari. Sorry!');
  }
});

</script>
</body></html>
