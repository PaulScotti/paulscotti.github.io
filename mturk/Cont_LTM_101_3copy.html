<!-- Paul Scotti 2017
originally modified from Tim Brady http://timbrady.org/turk/ensembleindivdiff/e9/ -->

<!-- Preload javascript and css files -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<script src="./Cont_LTM_101_files/jquery.min.js"></script>
<script src="./Cont_LTM_101_files/seedrandom.js"></script>
<script src="./Cont_LTM_101_files/colors.js"></script>
<script src="./Cont_LTM_101_files/TimTurkTools.js"></script>
<script src="./Cont_LTM_101_files/beep.js"></script>
<script src="./Cont_LTM_101_files/jcanvas.min.js"></script>  
<script src="./Cont_LTM_101_files/chance.js"></script> 
<script src="./Cont_LTM_101_files/blockedList.js"></script>  
<script src="lodash.core.js"></script>
    
<!-- load Firebase server javascript, we are just using it for storage -->
<script src="https://www.gstatic.com/firebasejs/4.8.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.8.2/firebase-storage.js"></script>

<link rel="stylesheet" type="text/css" href="./Cont_LTM_101_files/contReport.css">
<link rel="stylesheet" type="text/css" href="./Cont_LTM_101_files/showTrials.css">
<link rel="stylesheet" type="text/css" href="./Cont_LTM_101_files/experiment.css"> 

</head>
<body style="">

<!-- Consent statement: -->
<div id="consentDiv"><h1>The Ohio State University Consent to Participate in Research</h1><h2>Study Title: Individual variation in attention, cognitive control, and memory</h2><h2>Researchers: Paul S. Scotti, Yoolim Hong, Julie D. Golomb, Andrew B. Leber</h2> <p><b>This is a consent form for research participation.</b> It contains important information about this study and what to expect if you decide to participate.</p><p><b>Your participation is voluntary.</b></p><p>Please consider the information carefully. Feel free to email questions to the researchers before making your decision whether or not to participate.  If you decide to participate, you will be asked to click a button below this form.</p><p><b>Purpose:</b> In this experiment, we are interested in understanding how humans are able to control their attention to focus on relevant information, and how attention is related to other cognitive abilities and traits.</p><p><b>Procedures/Tasks:</b> Your participation involves watching various visual events on a computer screen and responding to what you saw. Additionally, you may be asked to complete a survey. You will be provided with detailed written instructions at the start of each task or survey</p><p><b>Duration:</b> The experiment is expected to take the duration listed in the HIT description, and will not exceed 60 minutes in duration. You may leave the study at any time.  If you decide to stop participating in the study, there will be no penalty to you, and you will not lose any benefits to which you are otherwise entitled.  Your decision will not affect your future relationship with The Ohio State University.</p><p><b>Risks and Benefits:</b> There is no more risk associated with participation than you would normally encounter while playing a simple video game.  Benefits include advance scientific knowledge, experiencing the research process, and learning about attention and cognitive control (via debriefing).</p><p><b>Confidentiality:</b> Upon completed of the HIT, your Amazon Mechanical Turk Worker ID will be made available to the experimenters. Only select lab personnel will have access to the requester Mechanical Turk site, and Worker IDs will be used only to confirm study completion, assign compensation, and, in some cases, to invite you to participate in a follow-up study.</p><p>The data that you provide in the experiment will be stored temporarily on a secure private online server or on the web-survey platform Qualtrics, then transferred to our secure lab computers. Your name or contact information will not be collected during the experiment. Only select lab personnel who have received training in human subjects protection and clearance to handle data for this project will have access to your results. We will work to make sure that no one sees your data without approval. But, because we are using the Internet, there is a chance that someone could access your online responses without permission. In some cases, this information could be used to identify you. Your data will be protected with a code to reduce the risk that other people can view the responses. However, there are rare instances when the researcher may be required to share personally identifiable information. For example, in response to a complaint about the research, officials at The University and/or regulatory oversight government agencies (National Science Foundation) may access research data.  The researcher is also required by law to report certain information to government and/or law enforcement officials (e.g., threatened violence against self or others, communicable diseases).</p><p><b>Incentives:</b> You will receive the compensation amount listed in the HIT description (based on a rate of $6/hour). If you withdraw early for any reason, your payment will be prorated to the nearest increment of 10 minutes based on a $6/hour rate, up until the amount indicated in the HIT description. If you withdraw early, please contact the researcher at scotti.5@osu.edu to ensure you receive your compensation.</p><p><b>Participant Rights:</b> You may refuse to participate in this study without penalty or loss of benefits to which you are otherwise entitled. If you are a student or employee at Ohio State, your decision will not affect your grades or employment status.</p><p>If you choose to participate in the study, you may discontinue participation at any time without penalty or loss of benefits.  By consenting below, you do not give up any personal legal rights you may have as a participant in this study.</p><p>An Institutional Review Board responsible for human subjects research at The Ohio State University reviewed this research project and found it to be acceptable, according to applicable state and federal regulations and University policies designed to protect the rights and welfare of participants in research.</p><p><b>Contacts and Questions:</b> For questions, concerns, or complaints about the study, or you feel you have been harmed as a result of study participation, you may contact either Paul Scotti at scotti.5@osu.edu or Andrew Leber at leber.30@osu.edu. For questions about your rights as a participant in this study or to discuss other study-related concerns or complaints with someone who is not part of the research team, you may contact Ms. Sandra Meadows in the Office of Responsible Research Practices at meadows.8@osu.edu.</p><p><b>Electronic consent:</b> You may print a copy of this consent form for your records. If you wish to continue with the experiment, please click the button below.<br><center><b>Clicking the button below indicates that:</b><br>You have read the above information<br>You are 18 years of age or older<br>You voluntarily agree to participate<br></p><br></center><p style="text-align: center"><a href="javascript:$('#consentDiv').hide();$('#instructions').show();document.body.scrollTop = document.documentElement.scrollTop = 0;" id="startExperimentButton" style="display: inline;">I consent to participate in this study</a></p></div>    
    
<!-- Instructions: -->
<div id="instructions" style="display: none">
<p>In this HIT, you will have to perform 2 separate tasks. It should take about 15 minutes total to complete. The first task is an attentional task and the second is a memory task.</p>
<p>In the first part, you will see colored objects presented one at a time. For example, one object may look like this:</p>
<p align="center"><img src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/Instruct1.png" width="400"></p>
<p><strong>If an object is ever immediately repeated</strong> (e.g., the same phone is presented twice in a row), then click on the screen using your mouse. Be aware that you only have 2 seconds to respond before the next object is presented. You will hear a high-pitched beep for a correct response and a low-pitched beep for an incorrect response.</p>

<p> After you have seen all of the objects, you will be tested on your memory for each object's color. A previously observed object will be presented on the screen, and you will be required to move your mouse around a black outside circle to adjust the color of the object. Once you feel you have matched the color of the object to its originally presented color, click using your mouse to lock in your answer and move on to the next object.</p>

<p align="center"><img src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/Instruct2.png" width="400"></p>

<p>It is important that you be as <em>precise and as accurate as possible</em> when reporting the original colors for the objects. Also note that since this is an experiment designed to study memory, we advise that you <strong>do not take any breaks after starting this study</strong>.

<p><strong>To start off with, we'll give you a few practice trials</strong>. During practice, you will see colored objects presented one at a time. Remember to click on the screen as quickly as possible if an object is immediately repeated. After you have seen all the practice objects, you will then be asked to report the original colors of the objects.</p> 

<br><p style="text-align: center"><a href="javascript:StartExperiment();document.body.scrollTop = document.documentElement.scrollTop = 0;" id="startExperimentButton" style="display: inline;">Start Experiment</a><span id="loading" style="display: none;">Images still loading. Please wait. &nbsp; &nbsp; <img src="./Cont_LTM_101_files/spinner.gif" style="width: 30px; height: 30px"></span></p>
</div>

<!-- Start form here to capture comments -->
<form name="turkSubmit" id="turkSubmit" action="https://workersandbox.mturk.com/mturk/externalSubmit" method="POST">
<input type="hidden" name="assignmentId" id="assignmentId" value="" >
<input type="hidden" name="foo" value="" >
<input type="submit" value="Submit" name="submitButton" id="submitButton" style="display: none"></form>
<!-- submit to turk
https://workersandbox.mturk.com/mturk/externalSubmit
https://www.mturk.com/mturk/externalSubmit
-->

<!-- Screen for collecting comments when they are done: -->
<div id="done"><div id="doneText">Thanks very much for your participation!<br><br>Any comments for us? (Was it fun? Any technical difficulties?)<br><br>
<textarea name="comments" id="comments" style="width: 300px; height: 200px"></textarea><br><br>
<a href="javascript:SaveData()" id="timSubmit">Click to Submit HIT</a>
</div><div id="saving">Saving . . .</div></div>
    
<!-- Basic structure for a trial: -->

<div id="showTrial">
<div id="fixation">+</div>
<div id="allItems">
<canvas id="item"  width=400 height=400></canvas></div></div>
    
<!-- Structure for continuous report after the trial: -->
<div id="continuousReport"> 
<canvas id="contItem"  width=400 height=400></canvas>
<div id="ring"></div><div id="pointer">&nbsp;</div></div>
    
<!-- feedback -->
<div id="feedback">
    <div id="feedbackReportedText">Your response:</div><canvas id="feedbackReportedTri" width=300 height=300></canvas><div id="feedbackCorrectText">Correct response:</div><canvas id="feedbackCorrectTri" width=300 height=300></canvas><div id="feedbackError">Your error was: 10 deg (aim for less than 10 degrees!).<br>Click to continue.</div></div>
    
<form id="survey2" style="display: none;">
    <center>
    <div id = "doneText"><p>We secretly manipulated how likely objects were to have a certain color.<br><br><p>Did you notice that most objects were of approximately the same color?</p></div>
    <br><br><br><br>
    <input name="choice" type="radio" value="yes" id="surveyresponse" /> Yes
    <br><br>
    <input name="choice" type="radio" value="nope" id="surveyresponse2" /> Not really 
    <br><br><br><br>
    <a href="javascript:completeForm();" id="startExperimentButton" style="display: inline;">Submit</a>
    </center>
</form>
    
<!-- Preload images, needs to be below divs -->
<script src="./Cont_LTM_101_files/loadimg.js"></script>  
    
<script>      
curID = (IsOnTurk())? GetAssignmentId() : prompt("Doesn't look like you " + 
"are on Turk, so you're probably testing. Enter an ID to save your data with:", "id");    
    
CheckBlockList(blockedIDs,curID);
    
// Initialize Firebase
var config = {
    apiKey: "AIzaSyBeD1E8RCvOck3CeWzXbg2hGURf-sSrx8A",
    authDomain: "scotti-92222.firebaseapp.com",
    databaseURL: "https://scotti-92222.firebaseio.com",
    projectId: "scotti-92222",
    storageBucket: "scotti-92222.appspot.com",
    messagingSenderId: "123079954596"
};
firebase.initializeApp(config);
    
/* disable context menu 
document.oncontextmenu = function() {
    return false;
}*/

/* Options: */
var displayTime = 1000;
var isiTime = 1000;
var numTrialsPerPart = [4, 4]; // 240 trials
var origColors = _.clone(colors); // clone is required to create a new variable and not a pointer variable
var flippedColors = _.clone(colors).reverse();
flippedColors = flippedColors.concat(flippedColors.splice(0,180)); // shift array 180

var practiceTriTrials = [];
var triTrials = [];
var repeatTriTrials = [];
var totalTrials = [];

/* Pointers for where we are in the experiment: */
var currentTrial = -1;
var currentPart = 0;

var currentFeedTrial = -1;
var feedbackPhase = 0;
var repeat = 0;
var numRepeats = 0; 
var hit = 0;
var numHits = 0;
var falseHits = 0;
var mouseClick = -1;
survey = 0;
    
/* Randomize orderings */
Shuffle(dx.r_study);
chance1 = Chance(curID);
dx.r_study = dx.r_study.slice(0,numTrialsPerPart[1]);
dx.r_test = dx.r_study;
dx.r_test = chance1.shuffle(dx.r_test); 
chance1 = Chance(curID);
dx.r_pracimg = chance1.shuffle(dx.pracimg); 
chance1 = Chance(curID);
dx.r_TrialType = chance1.shuffle(dx.r_TrialType); 
chance1 = Chance(curID);
dx.rep_TrialType = chance1.shuffle(dx.rep_TrialType); 
chance1 = Chance(curID);

Shuffle(dx.r_repeatimg);
dx.r_repeatimg = dx.r_repeatimg.splice(dx.r_repeatimg.length-11); /*this means 12 repeats!*/
    
/* Setup reused image variable */
var img = new Image();
img.crossOrigin = "anonymous";
    
/* Setting up canvas contexts */
var item = document.getElementById("item");
var ctx = item.getContext("2d");
contItem = document.getElementById("contItem");
var ctx2 = contItem.getContext("2d");
var feedbackReportedTri = document.getElementById("feedbackReportedTri");
var ctx3 = feedbackReportedTri.getContext("2d");
feedbackCorrectTri = document.getElementById("feedbackCorrectTri");
var ctx4 = feedbackCorrectTri.getContext("2d");
    
/* Generate trials: Do it the same for each subject by seeding the random number generator the same every time. */
function GenerateTrials() {
  Math.seedrandom(curID); /* Use their ID as the random seed generator, so you can trace back their trials */
    
  seed = Math.floor(Math.random()*360);
  seed = [seed, (seed + 90)];
  seed = [seed[0], seed[1], (seed[1] + 90)];
  seed = [seed[0], seed[1], seed[2], (seed[2] + 90)];
  wrap(seed);
    
  for (var i=0; i<numTrialsPerPart[1]; i++) { 
    var pickSeed = dx.r_TrialType[i];
    var curMean = seed[pickSeed] + (Math.floor(Math.random()*90) - 45);
    wrap(curMean);
      triTrials.push({'mean': curMean, 
                      'type': 'color', 
                      'isPractice': 0,
                      'items': curMean});
  }
  triTrials = Shuffle(triTrials);

  for (var i=0; i<numTrialsPerPart[0]; i++) { 
    var curMean = Math.floor(Math.random()*360);
    practiceTriTrials.push({'mean': curMean, 
                    'type': 'color', 
                    'isPractice': 1,
                    'items': curMean});
  }
    
  for (var i=0; i<dx.rep_TrialType.length; i++) { 
    var pickSeed = dx.rep_TrialType[i];
    var curMean = seed[pickSeed] + (Math.floor(Math.random()*90) - 45);
    wrap(curMean);
    repeatTriTrials.push({'mean': curMean, 
                    'type': 'color', 
                    'isPractice': 0,
                    'items': curMean});
  } 
    repeatTriTrials = Shuffle(repeatTriTrials);
}

/* Start the experiment. */
function StartExperiment() {
  if (IsOnTurk() && IsTurkPreview()) {
    alert("Please accept the HIT before continuing.");
    return false;
  }
  GenerateTrials();

  totalTrials = [practiceTriTrials, triTrials];
  r_totalTrials = [chance1.shuffle(practiceTriTrials), triTrials];
    
  chance1 = Chance(curID); /* Use their ID as the random seed generator, so you can trace back their trials */
  r_totalTrials = [r_totalTrials[0], chance1.shuffle(triTrials)];

  $('#instructions').hide();
    
  NextTrial();
}

/* Show the next trial or show the done screen if they are finished: */
function NextTrial() {
  currentTrial++;
  $('#fixation').css('color','black'); /* fixation back to black in case it wasn't */
    
  if (currentTrial>numTrialsPerPart[currentPart]-1) {
      alert("You will now see previously displayed objects again, one at a time. Please move your mouse along the black outside circle to adjust the color of the object until it matches its original color (be as precise as possible). Then click to continue.");
      /* Start continuous color report trials */
      NextFeedTrial();
      /* need return; otherwise the ShowTrial below executes */
      return;
  }
  ShowTrial(totalTrials[currentPart][currentTrial]);
}
    
function RepeatTrial() { /* Should be renamed abrupt-onset trial, not RepeatTrial */
  var imgNum = repeatTriTrials[numRepeats].mean;
  repeat = repeat + 1;
    
  if (repeat == 1) {
      tempTrial = currentTrial;
      currentTrial = -999; }
  var centerX = 300, centerY = 300;
  var ringSize = 250;
  var angleDeg = 0;
  var curError = 360;
  var startTime = new Date();
    
  var flip = Math.round(Math.random());
  var randrotate = Math.floor(Math.random()*360);
    
$(document).bind('mousemove.curTrial', function(e) {
        var parentOffset = $('#continuousReport').offset(); 
        var relX = e.pageX - parentOffset.left - centerX;
        var relY = e.pageY - parentOffset.top - centerY;
        var curAngle = Math.atan2(relY,relX);
        angleDeg = curAngle / Math.PI * 180.0;
        var imgNum = Math.round(angleDeg);
        mouseMoved = 1;
        start(ctx2,imgNum,200,200); 
        img.src = $('#' + dx.repeatimg[numRepeats])[0].src;

        $('#pointer').css({'left': centerX + Math.cos(curAngle)*ringSize-9, 
                           'top': centerY + Math.sin(curAngle)*ringSize-9});

        curError = Math.abs(angleDeg-repeatTriTrials[numRepeats].mean);
        if (curError > 180) {
            curError = 360-curError;
        }
        
        $('#feedbackError').html("Your error was: " + Math.round(curError) + " deg (aim for less than 30 deg!)<br><br>Click to continue.");
            
        if (e.isFakeTrigger) {
          trialStruct.startedAngle = Math.round(angleDeg);
        }
    });
  
    $(document).bind('click.curTrial', function(e) {
        /* Show approximate feedback: amazing! < 15, good! < 30 */
        if (curError <= 15) {
            feedText = 'Amazing!';
        } else if (curError <= 30) {
            feedText = 'Good!'; 
        } else {
            feedText = '...';
        }
        document.getElementById("fixation").innerHTML = feedText;

        if (mouseMoved == 0) {
            alert('Move your mouse around the circle to select the original object color. Please be as precise as possible.');
        } else {
            trialStruct.reportedAngle = Math.round(angleDeg);
            trialStruct.rt = (new Date()) - startTime;
            $(document).unbind('click.curTrial');
            $(document).unbind('contextmenu.curTrial');
            $(document).unbind('mousemove.curTrial');
            $("#continuousReport").hide();
            $('#feedbackError').html("Your error was: " + Math.round(curError) + " deg (aim for less than 30 deg.!)<br><br>Click to continue.");

            var imgNum = Math.round(angleDeg);
            start(ctx3,imgNum,80,100);
            var imgNum = Math.round(repeatTriTrials[numRepeats].mean);
            start(ctx4,imgNum,40,100);

            if (currentFeedTrial+1 < numTrialsPerPart[0]) {
                img.src = $('#' + dx.repeatimg[numRepeats])[0].src;  
            }

            ctx2.drawImage(img, 200, 200); 
            $('#feedback').show();
            $(document).bind('click.feedback', function(e) {
                $('#feedback').hide(); 
                repeat = 0;
                NextTrial();
            });
        }
    });
    
  $("#continuousReport").show();    
  e = $.Event('mousemove');
  e.pageX = mouseX;
  e.pageY = mouseY;
  e.isFakeTrigger = true;
  $(document).trigger(e);
};
    
/* Show the next continuous color report trial: */
function NextFeedTrial() {
  /* Turn off listening for clicks, prevents beeping */
  $(document).off("click");
  currentFeedTrial++;
    
  if (currentFeedTrial>numTrialsPerPart[currentPart]-1) {
    if (currentPart == 1) {
      $('showTrial').hide;    
      Survey();
      return;
    } else {
      currentFeedTrial = -1;
      currentPart++;
        alert("Okay, time for the real experiment. Please do your best to remember the colors of the subsequent objects, and click the screen whenever an object repeats!");
        currentTrial = -1;
        NextTrial();
        return;
    }
  }
  
  if (currentFeedTrial <= 0) {
      /* Initialize first object */
      if (currentPart == 0) {
        img.src = $('#' + dx.r_pracimg[0])[0].src; 
      } else {
        img.src = $('#' + dx.r_test[0])[0].src; 
  }}
    
  ShowContinuousReport(r_totalTrials[currentPart][currentFeedTrial]);
        
  /* Set starting color as grayscale */
  start(ctx2,'gray',200,200); 
  mouseMoved = 0;
}

/* Basic trial structure: Wait for click; then show the stimuli for this trial; then delay for fixed ISI; then call ShowContinuousReport */
function ShowTrial(trialStruct) {
    var stopclick = 0;
    
    if (currentTrial == Math.ceil(numTrialsPerPart[1]/2) & currentPart == 1) {
        alert('You are half way through the learning phase of this experiment! Keep it up!');
    }
    
    $(document).on("click", function (e) {
        if (stopclick == 0) {
            new Beep(22050).play(400, .2, [Beep.utils.amplify(8000)]);
            $('#fixation').css('color','red');
            hit = 0;
            stopclick = 1;
        }
    });
    
    img.onload = function() {
      start(ctx,trialStruct.items,200,200); 
    }
    if (currentPart == 0) {
    img.src = $('#' + dx.pracimg[currentTrial])[0].src;
    } else {
    img.src = $('#' + dx.r_study[currentTrial])[0].src;
    }
    
    $('#allItems').css('margin-top', -1000);
    $('#showTrial').show();
    setTimeout(function() {
        $('#allItems').css('margin-top', 0);
        setTimeout(function() { 
            $('#allItems').css('margin-top', -1000);
            setTimeout(function() {
              $('#showTrial').hide();
                if (currentPart == 0) {
                    if (dx.repeatprac.includes(currentTrial)) { 
                        RepeatTrial(); 
                    } else {
                        NextTrial(); 
                    }
                } else {
                    if (dx.r_repeatimg.includes(100+currentTrial)) { 
                        RepeatTrial(); 
                    } else {
                        NextTrial(); 
                    }
                }
            }, isiTime);
        }, displayTime);
    }, 500);
}

/* Always track the mouse */
var mouseX, mouseY;
$(function() {
  $(document).bind('mousemove.overall', function(e) {
    mouseX = e.pageX;
    mouseY = e.pageY;
  });
});

function ShowContinuousReport(trialStruct) {
    
  var centerX = 300, centerY = 300;
  var ringSize = 250;
  var angleDeg = 0;
  var curError = 360;
  var startTime = new Date();
    
  var flip = Math.round(Math.random());
  var randrotate = Math.floor(Math.random()*360);
  // colors = colors.concat(colors.splice(0,randrotate)); //randomly rotate color wheel
  console.log(colors[1]);
    
    $(document).bind('mousemove.curTrial', function(e) {
        var parentOffset = $('#continuousReport').offset(); 
        var relX = e.pageX - parentOffset.left - centerX;
        var relY = e.pageY - parentOffset.top - centerY;
        var curAngle = Math.atan2(relY,relX);
        angleDeg = curAngle / Math.PI * 180.0;
        var imgNum = Math.round(angleDeg);
        mouseMoved = 1;
        start(ctx2,imgNum,200,200); 
        if (currentPart == 0) {
            img.src = $('#' + dx.r_pracimg[currentFeedTrial])[0].src;
        } else if (survey == 0) {
            img.src = $('#' + dx.r_test[currentFeedTrial])[0].src;
        } else if (survey == 1) {
            img.src = $('#999')[0].src;
        }
        $('#pointer').css({'left': centerX + Math.cos(curAngle)*ringSize-9, 
                           'top': centerY + Math.sin(curAngle)*ringSize-9});

        curError = Math.abs(angleDeg-trialStruct.mean);
        if (curError > 180) {
            curError = 360-curError;
        }
        
        if (trialStruct.isPractice) {
          $('#feedbackError').html("Your error was: " + Math.round(curError) + " deg (aim for less than 30 deg!)<br><br>Click to continue.");
        }
            
        if (e.isFakeTrigger) {
          trialStruct.startedAngle = Math.round(angleDeg);
        }
    });
  
    $(document).bind('click.curTrial', function(e) {
    
        /* Show approximate feedback: amazing! < 15, good! < 30 */
        if (curError <= 15) {
            feedText = 'Amazing!';
        } else if (curError <= 30) {
            feedText = 'Good!'; 
        } else {
            feedText = '...';
        }
        document.getElementById("fixation").innerHTML = feedText;
        
        if (survey == 1) {
            explicitErr = curError;
        }
        
        if (mouseMoved == 0) {
            alert('Move your mouse around the circle to select the original object color. Please be as precise as possible.');
        } else {
            trialStruct.reportedAngle = Math.round(angleDeg);
            trialStruct.rt = (new Date()) - startTime;
            $(document).unbind('click.curTrial');
            $(document).unbind('contextmenu.curTrial');
            $(document).unbind('mousemove.curTrial');
            $("#continuousReport").hide();
            if (survey == 0) {
                if (trialStruct.isPractice) {
                    $('#feedbackError').html("Your error was: " + Math.round(curError) + " deg (aim for less than 30 deg.!)<br><br>Click to continue.");

                    var imgNum = Math.round(angleDeg);
                    start(ctx3,imgNum,80,100);
                    var imgNum = Math.round(trialStruct.mean);
                    start(ctx4,imgNum,40,100);

                    if (currentFeedTrial+1 < numTrialsPerPart[0]) {
                    img.src = $('#' + dx.r_pracimg[currentFeedTrial+1])[0].src;  
                    }

                    ctx2.drawImage(img, 200, 200); 
                    $('#feedback').show();
                    $(document).bind('click.feedback', function(e) {
                        $('#feedback').hide(); 

                        if (currentFeedTrial+1 < numTrialsPerPart[0]) {
                            img.src = $('#' + dx.r_pracimg[currentFeedTrial+1])[0].src;  
                        }

                        ctx2.drawImage(img, 200, 200); 
                        NextFeedTrial();
                        document.getElementById("fixation").innerHTML = '+';
                        $(document).unbind('click.feedback');
                    });
                } else if (currentFeedTrial>=numTrialsPerPart[currentPart]-1) { /* this is to prepare the gray square in explicit test */
                    $('#showTrial').show();
                    img.src = $('#999')[0].src;  
                    setTimeout(function() {
                        ctx2.drawImage(img, 200, 200); 
                        NextFeedTrial();
                        document.getElementById("fixation").innerHTML = '+';
                        $('#showTrial').hide();
                    }, isiTime);
                } else { 
                    $('#showTrial').show();
                    if (currentFeedTrial < numTrialsPerPart[1]) {
                        img.src = $('#' + dx.r_test[currentFeedTrial+1])[0].src;  
                    }
                    setTimeout(function() {
                        ctx2.drawImage(img, 200, 200); 
                        NextFeedTrial();
                        document.getElementById("fixation").innerHTML = '+';
                        $('#showTrial').hide();
                    }, isiTime);
                }
            } else {
                $('#showTrial').hide();
                Survey2(); 
            }
        }
    });
    
  $("#continuousReport").show();    
  e = $.Event('mousemove');
  e.pageX = mouseX;
  e.pageY = mouseY;
  e.isFakeTrigger = true;
  $(document).trigger(e);
}

function Survey() { 
  $("#showTrial").hide(); 
  survey = 1;
  alert('Before you go, please select the most frequent color you think objects appeared as throughout the experiment.')
  ShowContinuousReport({mean: seed[0], type: "color", isPractice: 0, items: 999});
  start(ctx2,'gray',200,200); 
  mouseMoved = 0;
} 
    
function Survey2() {
    $("#survey2").show(); 
} 
    
/* Done with the experiment; wait for comments and for them to hit Save */
function Done() {
  $('#done').show();
}
    
/* Choose what to save and then put it on the server */
function SaveData() {
  $('#done').children().hide();
  $('#saving').show();
  $('#assignmentId').val(GetAssignmentId());
  var newDate = new Date();
  d = { 
    "curID": curID,
    "curTime": newDate.today() + " @ " + newDate.timeNow(),
    "userAgent": navigator.userAgent,
    "windowWidth": $(window).width(),
    "windowHeight": $(window).height(),
    "screenWidth": screen.width,
    "screenHeight": screen.height,    
    "comments": $('#comments').val(),
    "totalTrials": totalTrials,
    "explicitError": explicitErr,
    "implicitResponse": implicitResp,
    "seeds": seed,
    "StudyOrder": dx.r_study,
    "TestOrder": dx.r_test,
    "SeedOrder": dx.r_TrialType,
    "RepSeedOrder": dx.rep_TrialType,
    "numcorrectrepeats": numHits,
    "numfalserepeats": falseHits
  };
    
    /* save to Firebase server */
    var blob = new Blob([JSON.stringify(d)], {type: "application/json"});
    var storageRef = firebase.storage().ref('data/' + curID + '.json');
    storageRef.put(blob);
    
    document.getElementById("saving").innerHTML = "Done!";
    
    document.forms[0].submit();
}

function start(context,deg,initX,initY) {
    if (deg == 'gray') {
        var col = [0,0,0];
    } else {
        deg=(deg>=360)?deg-360:deg;
        deg=(deg<0)?deg+360:deg;
        var col=colors[deg];
    }
    
    context.drawImage(img, initX, initY);
    recolor(context,Math.round(col[0]),Math.round(col[1]),Math.round(col[2]),initX,initY);
}
function recolor(context,newR,newG,newB,initX,initY) {
     var imgData = context.getImageData(initX, initY, item.width, item.height);
     var data = imgData.data;
    for (var i = 0; i < data.length; i += 4) {
        red = data[i + 0];
        green = data[i + 1];
        blue = data[i + 2];
        ro = red;
        newRgb.r = (red > 0) ? newR;
        newRgb.g = (red > 0) ? newG;
        newRgb.b = (red > 0) ? newB;
    }
    context.putImageData(imgData, initX, initY);
}
function HSVtoRGB(h, s, v) {
    var r, g, b, i, f, p, q, t;
    if (arguments.length === 1) {
        s = h.s, v = h.v, h = h.h;
    }
    i = Math.floor(h * 6);
    f = h * 6 - i;
    p = v * (1 - s);
    q = v * (1 - f * s);
    t = v * (1 - (1 - f) * s);
    switch (i % 6) {
        case 0: r = v, g = t, b = p; break;
        case 1: r = q, g = v, b = p; break;
        case 2: r = p, g = v, b = t; break;
        case 3: r = p, g = q, b = v; break;
        case 4: r = t, g = p, b = v; break;
        case 5: r = v, g = p, b = q; break;
    }
    return {
        r: Math.round(r * 255),
        g: Math.round(g * 255),
        b: Math.round(b * 255)
    };
}
function RGBtoHSV(r, g, b) {
    if (arguments.length === 1) {
        g = r.g, b = r.b, r = r.r;
    }
    var max = Math.max(r, g, b), min = Math.min(r, g, b),
        d = max - min,
        h,
        s = (max === 0 ? 0 : d / max),
        v = max / 255;

    switch (max) {
        case min: h = 0; break;
        case r: h = (g - b) + d * (g < b ? 6: 0); h /= 6 * d; break;
        case g: h = (b - r) + d * 2; h /= 6 * d; break;
        case b: h = (r - g) + d * 4; h /= 6 * d; break;
    }

    return {
        h: h,
        s: s,
        v: v
    };
}  
    
/* Make sure all numbers in an array are between 0 and 360: */
function wrap(v) {
  for (var i=0; i<v.length; i++) {
    if (v[i]>360) { v[i]-=360; }
    if (v[i]<0) { v[i]+=360; }
  }
  return v;
} 

function completeForm() {
    if (document.getElementById("surveyresponse").checked) {
        implicitResp = 1;
    } else if (document.getElementById("surveyresponse2").checked) {
        implicitResp = 2;
    }
    //proceed only if they picked one of two options
    if (implicitResp > 0) {
        $('#survey2').hide();
        $('#instructions').hide();
        Done();
    } else {
        alert('Please select an option.');
    }  
    return false;  
}
    
$(window).load(function () {
  $('#startExperimentButton').show();
  $('#loading').hide();
});

$(function() {
  if (navigator.userAgent.indexOf('MSIE') != -1) {
    $('body').html('Unfortunately this HIT does not work in IE. It works in Chrome, Firefox or Safari. Sorry!');
  }
});    
    
</script>
</body></html>