<!-- Paul Scotti 2018 -->
<!-- v101 WM test on one obj in center of screen, 1000m study -->

<!-- Preload javascript and css files -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/jquery.min.js"></script>
<script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/seedrandom.js"></script>
<script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/TimTurkTools.js"></script>
<script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/jcanvas.min.js"></script>
<script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/chance.js"></script>
<script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/lodash.core.js"></script> <!-- Allows _clone -->

<!-- load Firebase server javascript, we are using it for storage -->
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>

<link rel="stylesheet" type="text/css" href="https://paulscotti.github.io/mturk/InterGroup_Spatial_files/contReport.css">
<link rel="stylesheet" type="text/css" href="https://paulscotti.github.io/mturk/InterGroup_Spatial_files/showTrials.css">
<link rel="stylesheet" type="text/css" href="https://paulscotti.github.io/mturk/InterGroup_Spatial_files/experiment.css">

</head>
<body style="">

<!-- Consent statement: -->
<div id="consentDiv"><h1>The Ohio State University Consent to Participate in Research</h1><h2>Study Title: Individual variation in attention, cognitive control, and memory</h2><h2>Researchers: Paul S. Scotti, Yoolim Hong, Julie D. Golomb, Andrew B. Leber</h2> <p><b>This is a consent form for research participation.</b> It contains important information about this study and what to expect if you decide to participate.</p><p><b>Your participation is voluntary.</b></p><p>Please consider the information carefully. Feel free to email questions to the researchers before making your decision whether or not to participate.  If you decide to participate, you will be asked to click a button below this form.</p><p><b>Purpose:</b> In this experiment, we are interested in understanding how humans are able to control their attention to focus on relevant information, and how attention is related to other cognitive abilities and traits.</p><p><b>Procedures/Tasks:</b> Your participation involves watching various visual events on a computer screen and responding to what you saw. Additionally, you may be asked to complete a survey. You will be provided with detailed written instructions at the start of each task or survey.</p><p><b>Duration:</b> The experiment is expected to take the duration listed in the HIT description. You may leave the study at any time.  If you decide to stop participating in the study, there will be no penalty to you, and you will not lose any benefits to which you are otherwise entitled.  Your decision will not affect your future relationship with The Ohio State University.</p><p><b>Risks and Benefits:</b> There is no more risk associated with participation than you would normally encounter while playing a simple video game.  Benefits include advance scientific knowledge, experiencing the research process, and learning about attention and cognitive control.</p><p><b>Confidentiality:</b> Upon completed of the HIT, your Amazon Mechanical Turk Worker ID will be made available to the experimenters. Only select lab personnel will have access to the requester Mechanical Turk site, and Worker IDs will be used only to confirm study completion, assign compensation, and, in some cases, to invite you to participate in a follow-up study.</p><p>The data that you provide in the experiment will be stored temporarily on a secure private online server or on the web-survey platform Qualtrics, then transferred to our secure lab computers. Your name or contact information will not be collected during the experiment. Only select lab personnel who have received training in human subjects protection and clearance to handle data for this project will have access to your results. We will work to make sure that no one sees your data without approval. But, because we are using the Internet, there is a chance that someone could access your online responses without permission. In some cases, this information could be used to identify you. Your data will be protected with a code to reduce the risk that other people can view the responses. However, there are rare instances when the researcher may be required to share personally identifiable information. For example, in response to a complaint about the research, officials at The University and/or regulatory oversight government agencies (National Science Foundation) may access research data.  The researcher is also required by law to report certain information to government and/or law enforcement officials (e.g., threatened violence against self or others, communicable diseases).</p><p><b>Incentives:</b> You will receive the compensation amount listed in the HIT description (based on a rate of $6/hour). If you withdraw early for any reason, your payment will be prorated to the nearest increment of 10 minutes based on a $6/hour rate, up until the amount indicated in the HIT description. If you withdraw early, please contact the researcher at scotti.5@osu.edu to ensure you receive your compensation.</p><p><b>Participant Rights:</b> You may refuse to participate in this study without penalty or loss of benefits to which you are otherwise entitled. If you are a student or employee at Ohio State, your decision will not affect your grades or employment status.</p><p>If you choose to participate in the study, you may discontinue participation at any time without penalty or loss of benefits.  By consenting below, you do not give up any personal legal rights you may have as a participant in this study.</p><p>An Institutional Review Board responsible for human subjects research at The Ohio State University reviewed this research project and found it to be acceptable, according to applicable state and federal regulations and University policies designed to protect the rights and welfare of participants in research.</p><p><b>Contacts and Questions:</b> For questions, concerns, or complaints about the study, or you feel you have been harmed as a result of study participation, you may contact either Paul Scotti at scotti.5@osu.edu. For questions about your rights as a participant in this study or to discuss other study-related concerns or complaints with someone who is not part of the research team, you may contact Ms. Sandra Meadows in the Office of Responsible Research Practices at meadows.8@osu.edu.</p><p><b>Electronic consent:</b> You may print a copy of this consent form for your records. If you wish to continue with the experiment, please click the button below.<br><center><b>Clicking the button below indicates that:</b><br>You have read the above information<br>You are 18 years of age or older<br>You voluntarily agree to participate<br></p><br></center><p style="text-align: center"><a href="javascript:void(0);" onclick="$('#consentDiv').hide();$('#instructions').show();document.body.scrollTop = document.documentElement.scrollTop = 0;$('a#TextButton').show()" id="TextButton" style="display: inline;">I consent to participate in this study</a></p></div>

<!-- Instructions: -->
<div id="instructions" style="display: none">
<center><b><p>This HIT lasts approximately one hour.</p>
<p>You will receive $6.00 for HIT completion, plus a bonus (up to $5.60) based on performance.</p>
<p>If you have previously completed this HIT then you are ineligible to participate.</p>
<p>Please do not disable the creation of text dialogs as these will be used to relay instructions.</p></b></center>
<br><p style="text-align: center"><a href="javascript:void(0);" onclick="$('#instructions').hide();$('#instructions2').show();document.body.scrollTop = document.documentElement.scrollTop = 0;" id="TextButton">Next (1 of 4)</a></p>
</div>

<div id="instructions2" style="display:none"><center>
<p>In this HIT, you will memorize the colors of a variety of objects and subsequently be tested on them.</p></center>

<p align="center"><img src="https://paulscotti.github.io/mturk/InterGroup_Spatial_files/trial_procedure_InterGroup_top.png" width="650px"></p>

<p>Two objects will be displayed for one second, followed by an irrelevant mask and a short delay. You will then be asked to recreate the original color of one of the objects.</p>

<br><p style="text-align: center"><a href="javascript:void(0);" onclick="$('#instructions2').hide();$('#instructions3').show();document.body.scrollTop = document.documentElement.scrollTop = 0;" id="TextButton">Next (2 of 4)</a></p>
</div>

<div id="instructions3" style="display:none">

<p align="center"><img src="https://paulscotti.github.io/mturk/InterGroup_Spatial_files/trial_procedure_InterGroup_bottom.png" width="650px"></p>

<p>One of the two objects will be presented in black and white. To recreate the color, move your mouse around the color wheel. Once you feel you have located the correct color on the wheel, click using your mouse to lock in your answer.</p>

<p>It is important that you be as <em>precise and as accurate as possible</em> when reporting the original colors of the objects. (A poor graduate student will spend hours analysing your data.) You can take short breaks at the end of every block (20 trials). There is a time limit to finish the HIT (3 hours), but this should allow plenty of time for breaks.

<p>If you do not know the correct color, move your mouse around the color wheel and select what feels right. You are not allowed to use any external tools to remember objects.</p>

<p>After you have selected your best guess, you will be asked to highlight the region of the color wheel that represents how confident you are about your answer. That is, the colors contained in this highlighted portion (shown as a black border around the color wheel) represent the smallest range of colors you think could contain the original object's color. If you believed the original color to be somewhere between red and purple then you would highlight that portion of the color wheel. If you were very certain about your answer then you would highlight a small range of colors, and if you were completely guessing then you would highlight the entirety of the color wheel.</p>

<p><strong>Every trial has the potential for you to earn two bonus cents. Specifically, one cent is awarded based on how close your best guess is to the correct color. Another cent is awarded based on how small your highlighted regions is: a smaller highlighted region earns more but only if the highlighting encompasses the correct color.</strong> This means that you will often be earning fractions of cents on every trial, but this can add up!</p>

<br><p style="text-align: center"><a href="javascript:void(0);" onclick="$('#instructions3').hide();$('a#TextButton').hide();$('#instructions4').show();document.body.scrollTop = document.documentElement.scrollTop = 0;ImagesReady();" id="TextButton">Next (3 of 4)</a></p>
</div>

<div id="instructions4" style="display:none">
<center><p>The entire HIT includes 280 trials and takes approximately 1 hour to complete.</p>

<p><u>As a recap, here is an animated example of a few trials of the experiment:</u></p></center>

<p align="center"><img src="https://paulscotti.github.io/mturk/InterGroup_Spatial_files/InterGroup_Instruct_edit.gif"></p>

<p><strong>To start off with, we'll give you a few practice trials</strong>. During practice, you will see two colored objects at a time. Remember to memorize the colors associated with each object. You will then be asked to report the original color of one of the objects. Please take your time to respond as accurately as possible. The hour time estimate assumes a patient worker who takes their time for every reponse!</p>

<p style="text-align: center"><a href="javascript:void(0);" onclick="$('#instructions4').hide();$('a#TextButton').hide();StartExperiment();document.body.scrollTop = document.documentElement.scrollTop = 0;" id="TextButton">Start Experiment</a></p>
<center><p id=loading>Images loading... Please wait.</p>
</div>

<!-- Start form here to capture comments -->
<form name="turkSubmit" id="turkSubmit" action="https://workersandbox.mturk.com/mturk/externalSubmit" method="POST">
<input type="hidden" name="assignmentId" id="assignmentId" value="" >
<input type="hidden" name="foo" value="" >
<input type="submit" value="Submit" name="submitButton" id="submitButton" style="display: none"></form>
<!-- submit to turk
https://workersandbox.mturk.com/mturk/externalSubmit
https://www.mturk.com/mturk/externalSubmit
-->

<!-- Screen for collecting comments when they are done: -->
<div id="done"><div id="doneText">Thanks very much for your participation! Your bonus may take a few extra days to process.<br><br>Any comments for us? (Was it fun? Any technical difficulties?)<br><br>
<textarea name="comments" id="comments" style="width: 400px; height: 300px"></textarea>
<center><p><div id="cashPrize">text</center></div></p>
<a href="javascript:void(0);" onclick="SaveData()" id="submitForm">Click to Submit HIT</a>
</div><div id="saving">Saving . . .</div></div>

<!-- Basic structure for a trial: -->
<div id="showTrial">
<div id="fixation">+</div>
<div id="allItems">
<div id='itemA_abs' style="position:absolute; top:150px; left:0px;">
<canvas id="itemA" width=300 height=300></canvas></div>
<div id='itemB_abs' style="position:absolute; top:150; left:300px;">
<canvas id="itemB" width=300 height=300></canvas></div>
<canvas id="CDitem" width=300 height=300></canvas>
</div><br><br>
<center><a href="javascript:void(0);" onclick="SamePress();ChangeDetection();" id="SameButton" style="display: hidden; ">Same</a>
<a href="javascript:void(0);" onclick="DiffPress();ChangeDetection();" id="DiffButton" style="display: hidden;">Different</a>
<div id="underText2"><p>Did this square stay the same color or change to a different color?</p></div></center>
</div>

<!-- Structure for continuous report after the trial: -->
<div id="continuousReport">
<div id='contItem_abs' style="position:absolute;">
<canvas id="contItemA" width=600 height=600></canvas></div>
<!-- <div id='contItemB_abs' style="position:absolute; top:150; left:300px;">
<canvas id="contItemB" width=300 height=300></canvas></div> -->
<canvas id="ringItemA"  width=600 height=600 style="position: absolute;"></canvas>
<!-- <canvas id="ringItemB"  width=280 height=280 style="position: absolute; top:160px; left:310px;"></canvas> -->
<div id="pointer"></div>
<div id="popQuiz"><p>What was the color of this object?/p></div>
<div id="underText"><p></p></div>
</div>

<!-- feedback -->
<div id="feedback">
    <div id="feedbackReportedText">Your response:</div><canvas id="feedbackReportedTri" width=300 height=300></canvas><div id="feedbackCorrectText">Correct response:</div><canvas id="feedbackCorrectTri" width=300 height=300></canvas><div id="feedbackError">Your error was: 10 deg (aim for less than 50 degrees!).<br>Click to continue.</div></div>

<form id="survey1" style="display: none;">
    <center>
    <div id = "doneText"><p>You finished! Just a few questions before you go:<p><br><p>What strategy (if any) did you use when selecting the colors of objects?</p></div>
    <br><br><br><br>
    <textarea name="strategy" id="strategy" style="width: 400px; height: 200px"></textarea><br><br>
    <a href="javascript:void(0);" onclick="Done();" id="TextButton" style="display: inline;">Submit</a>
    </center>
</form>

<form id="survey2" style="display: none;">
    <center>
    <div id = "doneText"><p>Do you think object colors were sampled randomly from the color wheel or do you think objects often shared approximately the same color?</p></div>
    <br><br><br><br>
    <input name="choice" type="radio" value="nope" id="surveyresponseRand" /> Each color chosen at random
    <br><br>
    <input name="choice" type="radio" value="yes" id="surveyresponsePref" /> Some portion of colors chosen more than others
    <br><br><br><br>
    <a href="javascript:void(0);" onclick="Survey();" id="TextButton" style="display: inline;">Submit</a>
    </center>
</form>

<form id="survey3" style="display: none;">
    <center>
    <div id = "doneText"><p>How confident are you that the biased color region you selected is close to the actual experimental manipulation?</p></div>
    <br><br><br><br>
    <div class="likertButtons">
    Less certain
    <label for="likert1">1<input id="likertConfidence" type="radio" name="likertz" value="1"></label>
    <label for="likert2">2<input id="likertConfidence" type="radio" name="likertz" value="2"></label>
    <label for="likert3">3<input id="likertConfidence" type="radio" name="likertz" value="3"></label>
    <label for="likert4">4<input id="likertConfidence" type="radio" name="likertz" value="4"></label>
    <label for="likert5">5<input id="likertConfidence" type="radio" name="likertz" value="5"></label>
    <label for="likert6">6<input id="likertConfidence" type="radio" name="likertz" value="6"></label>
    More certain
    </div>
    <br><br>
    <a href="javascript:void(0);" onclick="Done();" id="TextButton" style="display: inline;">Submit</a></center>
</form>

<!-- Preload images, needs to be below divs -->
<script src="https://paulscotti.github.io/mturk/InterGroup_Spatial_files/loadimg.js"></script>

<script>
let WORKERID = (IsOnTurk())? GetWorkerId() : prompt("You don't look like an mTurker! " +
"Enter an ID to save your data with (any number/string will do). Note your id is used to seed the experiment rng:", "workID");
let ASSIGNMENTID = (IsOnTurk())? GetAssignmentId() : prompt("Set assignment number (doesnt matter for testing):", "assignmentId");

// Initialize Firebase
const config = {
    apiKey: "AIzaSyBeD1E8RCvOck3CeWzXbg2hGURf-sSrx8A",
    authDomain: "scotti-92222.firebaseapp.com",
    databaseURL: "https://scotti-92222.firebaseio.com",
    projectId: "scotti-92222",
    storageBucket: "scotti-92222.appspot.com",
    messagingSenderId: "123079954596"
};
firebase.initializeApp(config);

/* disable context menu
document.oncontextmenu = function() {
    return false;
}*/

const chance1 = Chance(WORKERID); // Use their ID as the shuffle seed, so you can trace back their trials

/* Options: */
const totalRepeats = 0; // 30 need be factor of r_TrialType.length (in this case it's 5)
const numTrialsPerPart = [1, 20, 20]; // [5, 280, 280] prac, study, test (should = study); 240 tested nonrepeat trials
let block = 1;
const trialsPerBlock = 5; //20
const totBlocks = numTrialsPerPart[1]/trialsPerBlock;
</script> <script src="https://paulscotti.github.io/mturk/InterGroup_Spatial_files/colors_blocked.js"> </script>

<script>

let imgNum = 0;
const imgWidth = 200;
const imgHeight = 200;
const displayTime = 1000;
const isiTime = 800;
const feedbackTime = 750;
const maskTime = 200;
const origColors = _.clone(colors); // clone is required to copy a variable without it accidentally referencing the same thing
let flippedColors = _.clone(colors).reverse();
flippedColors = flippedColors.concat(flippedColors.splice(0,180)); // shift array 180

let practiceTriTrials = [];
let triTrials = [];
let triTrialsTest = [];
let repeatTriTrials = [];
let totalTrials = [];
let r_totalTrials = [];

/* Pointers for where we are in the experiment: */
let currentTrial = -1;
let currentPart = 0;
let currentFeedTrial = -1;
let nextTrialStart = 1;
let feedbackPhase = 0;
let repeat = 0;
let numRepeats = 0;
let mouseClick = -1;
let randrotate = 0;
let angleDeg = 0; let angleDeg2 = 0; let angleDeg3 = 0;
let curAngle = 0;
let curError = 360;
let seed = [];
let flip = 0;
let survey = 0;
let readyRepeat = 0;
let waitObject = 0;
const radius = 242; //134;
const ringSize = 242; //134;
const centerX = 300; const centerY = 300;
let points = 0;
let feedText = '';
let basepay = 6;
let radioResp = 0;
let likertAns = 0;
let explicitColor = -999;
const startExpTime = new Date();
let mouseMoved = 0;
let startTime = -999;
let startingColor = -999;
let startAngle = -999; let startAngle2 = -999;
let diffAng2 = -999; let diffAng3 = -999;
let lastRot = -999; let lastRotMat = [];
let noMore = -999;
let relX = -999;
let relY = -999;
let parentOffset = -999;
let blockStart = 0;
let numCD = 0;
let CDtrial = 0; let sameTally = -1; let diffTally = -1;
let tooFast = [];
let tempVar = true;
let age = 0;
let sex = -999;
let left_or_right = 2;
let totConfidence = 0;
let LastLock = -99;

/* Randomize orderings */
dx.pracimgA = chance1.shuffle(dx.pracimgA);
dx.pracimgB = chance1.shuffle(dx.pracimgB);
dx.testimgA = chance1.shuffle(dx.testimgA);
dx.testimgB = chance1.shuffle(dx.testimgB);

/* Setup reused image variable */
let imgA = new Image();
imgA.crossOrigin = "anonymous";
let imgB = new Image();
imgB.crossOrigin = "anonymous";
let imgX = new Image();
imgX.crossOrigin = "anonymous";
let imgPop = new Image();
imgPop.crossOrigin = "anonymous";

/* Setup ring image */
let ringImg = new Image();
ringImg.crossOrigin = "anonymous";
ringImg.src = $('#ring')[0].src;

/* Setup CD images */
let imgCD = new Image();
imgCD.crossOrigin = "anonymous";
imgCD.src = $('#diff1')[0].src;
let CDfix = new Image();
CDfix.crossOrigin = "anonymous";
CDfix.src = $('#CDfixation')[0].src; //lowercase CDfixation refers to the actual image, CDFixation refers to the class
let imgCDtest = new Image();
imgCDtest.crossOrigin = "anonymous";
imgCDtest.src = $('#diff2')[0].src;
let Mask = new Image();
Mask.crossOrigin = "anonymous";
Mask.src = $('#MaskImg')[0].src

/* Setting up canvas contexts */
const itemA = document.getElementById("itemA");
const ctxA = itemA.getContext("2d");
const itemB = document.getElementById("itemB");
const ctxB = itemB.getContext("2d");
const contItemA = document.getElementById("contItemA");
const ctx2a = contItemA.getContext("2d");
// const contItemB = document.getElementById("contItemB");
// const ctx2b = contItemB.getContext("2d");
const feedbackReportedTri = document.getElementById("feedbackReportedTri");
const ctx3 = feedbackReportedTri.getContext("2d");
const feedbackCorrectTri = document.getElementById("feedbackCorrectTri");
const ctx4 = feedbackCorrectTri.getContext("2d");
const ringItemA = document.getElementById("ringItemA");
const ringctxA = ringItemA.getContext("2d");
// const ringItemB = document.getElementById("ringItemB");
// const ringctxB = ringItemB.getContext("2d");
const CDitem = document.getElementById("CDitem");
const cdctx = CDitem.getContext("2d");

imgX.src = $('#' + dx.pracimgA[0])[0].src;
// imgPop.src = $('#' + dx.repeatimg[numRepeats])[0].src;

/* Start by hiding text */
$('#popQuiz').hide();
$('#underText2').hide();

/* Generate trials: Do it the same for each subject by seeding the random number generator the same every time. */
function GenerateTrials() {
  if (WORKERID == null) {
    WORKERID = 'no_id';
  }
  if (typeof ASSIGNMENTID === 'undefined') {
    assignmentId = 'no_assignment';
  }
  if (typeof WORKERID === 'undefined') {
    workerId = 'no_workerId';
  }
  Math.seedrandom(WORKERID); /* Use their ID as the Math random seed generator, so you can trace back their trials */

  for (let i=0; i<numTrialsPerPart[1]; i++) {
    if (Math.round(Math.random()) == 0) { //itemA is tested
      thisTarget = dx.testimgA[i];
      thatRef = dx.testimgB[i];
      thisTarget_col = dx.imgAcolor[i];
      thatRef_col = dx.imgBcolor[i];
    } else { //itemB is tested
      thisTarget = dx.testimgB[i];
      thatRef = dx.testimgA[i];
      thisTarget_col = dx.imgBcolor[i];
      thatRef_col = dx.imgAcolor[i];
    }
    triTrials.push({'isPractice': 0,
                    'itemA_id': dx.testimgA[i],
                    'itemB_id': dx.testimgB[i],
                    'itemT_id': thisTarget,
                    'itemR_id': thatRef,
                    'itemA_col': dx.imgAcolor[i],
                    'itemB_col': dx.imgBcolor[i],
                    'itemT_col': thisTarget_col,
                    'itemR_col': thatRef_col,
                    'colorDiff': dx.sign[i],
                    'origTrial': i});
  }

  for (let blockNum=0; blockNum<=totBlocks; blockNum++) {
    let tempTest = _.clone(triTrials.slice(trialsPerBlock*blockNum,trialsPerBlock*(blockNum+1)));
    triTrialsTest.push.apply(triTrialsTest,chance1.shuffle(tempTest));
  }

  for (let i=0; i<numTrialsPerPart[0]; i++) {
    let cap = 360/numTrialsPerPart[0];
    let curMean = counter(1,360,cap);
    wrap(curMean);
    let amtchangepractice = Math.ceil(Math.random()*90) + 45
    if (Math.round(Math.random()) == 0) {
      thisTarget = dx.pracimgA[i];
      thatRef = dx.pracimgB[i];
      thisTargetCol = curMean[i];
      thatRefCol = wrap(curMean[i]+amtchangepractice);
    } else {
      thisTarget = dx.pracimgB[i];
      thatRef = dx.pracimgA[i];
      thisTargetCol = wrap(curMean[i]+amtchangepractice);
      thatRefCol = curMean[i];
    }
    practiceTriTrials.push({'isPractice': 1,
                    'itemA_id': dx.pracimgA[i],
                    'itemB_id': dx.pracimgB[i],
                    'itemA_col': curMean[i],
                    'itemB_col': wrap(curMean[i]+amtchangepractice),
                    'itemT_id': thisTarget,
                    'itemR_id': thatRef,
                    'itemT_col': thisTargetCol,
                    'itemR_col':thatRefCol
                  });
  }
}

/* Start the experiment, this function is the first to operate! */
function StartExperiment() {
  if (IsOnTurk() && IsTurkPreview()) {
    alert("Please accept the HIT before continuing.");
    return false;
  }
  GenerateTrials();

  age = prompt('Before we start, can you tell me how old you are (in years)?');

  while (!(age >0)) {
    age = prompt('Can you tell me how old you are (in years)?');
  }

  sex = prompt('And are you male (M), female (F), non-binary (B), or prefer not to answer (NA)?');

  while (!(sex == 'M' || sex == 'F' || sex == 'B' || sex == 'NA' || sex == 'm' || sex == 'f' || sex == 'b' || sex == 'na' || sex == 'female' || sex == 'male' || sex == 'Female' || sex == 'Male')) {
      sex = prompt('Are you male (M), female (F), non-binary (B), or prefer not to answer (NA)? Type one of the options shown in parentheses.');
  }
  if (sex == 'M' ||  sex == 'm' || sex == 'male' || sex == 'Male') {
    sex = 'm';
  } else if (sex == 'F' ||  sex == 'f' || sex == 'female' || sex == 'Female') {
    sex = 'f';
  }

  r_totalTrials = [practiceTriTrials, triTrials, triTrialsTest];

  $('#instructions').hide();
  NextTrial();
}

/* Show the next trial or show the done screen if they are finished: */
function NextTrial() {
  repeat = 0;
  currentTrial++;

  if (nextTrialStart == 0) { // if not first trial
    if (currentTrial>=numTrialsPerPart[currentPart] && currentPart == 0) { // if end of practice
      // alert("You will now see previously displayed objects again, one at a time. Please move your mouse around the color wheel to adjust the color of the object until it matches its original color (please be as precise as possible). Then click to lock in your response.\n\nPress [ENTER] to continue.");
      $('#showTrial').hide();
      nextTrialStart = 1;
      NextFeedTrial(); /* Start continuous color report trials */
      return; // need return; otherwise the ShowTrial below executes
    } else if (currentTrial % trialsPerBlock == 0 && currentPart == 1) { //if end of a test block
        if (currentTrial==numTrialsPerPart[1]) { //if last trial
          $('#showTrial').hide(); Survey1(); return;
        }
        numCD = 0; nextTrialStart = 1; block++;
        alert("Starting Block "+block+" of "+totBlocks+".");
        ShowTrial(r_totalTrials[currentPart][currentTrial]);
        return;
    }
  }
  nextTrialStart = 0;
  ShowTrial(r_totalTrials[currentPart][currentTrial]);
}

/* Basic trial structure: Wait for click; then show the stimuli for this trial; then delay for fixed ISI; then call ShowContinuousReport */
function ShowTrial(trialStruct) {
    start(ctxA,trialStruct.itemA_col,50, 50,imgWidth,imgHeight,flip,imgA,itemA);
    start(ctxB,trialStruct.itemB_col,50, 50,imgWidth,imgHeight,flip,imgB,itemB);

    imgA.src = $('#' + trialStruct.itemA_id)[0].src;
    imgB.src = $('#' + trialStruct.itemB_id)[0].src;

    $('#allItems').css('margin-top', -1000);
    $('#showTrial').show();
    setTimeout(function() {
        $('#allItems').css('margin-top', 0);
        setTimeout(function() {
            ctxA.onload = function() {
              ctxA.drawImage(Mask, 50, 50, imgWidth, imgHeight);
            }
            ctxA.drawImage(Mask, 50, 50, imgWidth, imgHeight);
            ctxB.onload = function() {
              ctxB.drawImage(Mask, 50, 50, imgWidth, imgHeight);
            }
            ctxB.drawImage(Mask, 50, 50, imgWidth, imgHeight);
            setTimeout(function() {
              $('#allItems').css('margin-top', -1000);
              setTimeout(function() {
                $('#showTrial').hide();
                  NextFeedTrial();
                }, isiTime);
            }, maskTime);
        }, displayTime);
    }, 500);
}

/* Show the next continuous color report trial: */
function NextFeedTrial() {
  if (blockStart == 0) {
    currentFeedTrial++;
    if (currentFeedTrial>numTrialsPerPart[currentPart]-1) { //if last test trial
      if (currentPart > 0) {
        $('showTrial').hide;
        Survey1();
        return;
      } else { //if last practice trial
        currentFeedTrial = -1;
        currentPart++;
        alert("Okay, time for the real experiment. You will receive a monetary bonus the better you perform. Thank you and we wish you the best of luck!");
        points = 0; currentTrial=-1;
        // imgX.src = $('#' + r_totalTrials[2][0].itemA)[0].src; /* preload first image of test phase */
        NextTrial();
        return;
      }
    //} else if (currentFeedTrial > 0 && currentFeedTrial % trialsPerBlock == 0 && currentPart == 1 && blockStart == 0) { //if last test trial in block
      //currentPart = 1;
      //alert('/')
      // /* Go back to study phase */
      // // alert("Starting study phase (Block "+block+" of "+totBlocks+").");
      // // imgX.src = $('#' + r_totalTrials[2][currentFeedTrial].itemA)[0].src; /* preload image */
      // NextTrial();
      // return;
    }
  } else {
    blockStart = 0;
  }

  /*Preload color wheel, first practice trial will have randrotate=0 and flip=0*/
  // if (left_or_right == 1) {
    ringctxA.restore();
    ringctxA.drawImage(ringImg,50,50,500,500);
    ringctxA.save();
  // } else {
  //   ringctxB.restore();
  //   ringctxB.drawImage(ringImg,0,0,280,280);
  //   ringctxB.save();
  // }

  if (!(currentPart == 0 && currentFeedTrial == 0)) { //dont clear ring if its first time ever presented, otherwise first practice trial has no ring
    ringctxA.clearRect(0,0,600,600);
    // ringctxB.clearRect(0,0,600,600);
  }
  mouseInit = mouseX;
  ShowContinuousReport(r_totalTrials[currentPart][currentFeedTrial]);
  mouseMoved = 0;
}

/* Always track the mouse */
let mouseX, mouseY;
$(function() {
  $(document).bind('mousemove.overall', function(e) {
    mouseX = e.pageX;
    mouseY = e.pageY;
  });
});

function ShowContinuousReport(trialStruct) {
  angleDeg = 0;
  curError = 360;
  startTime = new Date();
  $("#continuousReport").show(); /* Refresh the page to update same context set to new img src */

  $(document).bind('mousemove.curTrial', function(e) {
      parentOffset = $('#continuousReport').offset();
      relX = e.pageX - parentOffset.left - centerX;
      relY = e.pageY - parentOffset.top - centerY;
      curAngle = Math.atan2(relY,relX);
      angleDeg = curAngle / Math.PI * 180.0;
      if (mouseMoved == 0) {
        if (mouseInit != mouseX) {
        setTimeout(function() {
          imgNum = Math.round(wrap([angleDeg-randrotate]));
          startingColor = imgNum;
          mouseMoved = 1;
          // if (repeat == 0) {
          // if (left_or_right == 1) {
          start(ctx2a,imgNum,200,200,imgWidth,imgHeight,flip,imgA,itemA);
          mouseMoved = 1;
        }, 400); }
      } else {
        imgNum = Math.round(wrap([angleDeg-randrotate]));
        start(ctx2a,imgNum,200,200,imgWidth,imgHeight,flip,imgA,itemA);
      }
      // } else {
      //   start(ctx2b,imgNum,50, 50,imgWidth,imgHeight,flip,imgB,itemB);
      // }
      // } else if (repeat == 1) {
      //   start(ctx2,imgNum,50, 50,imgWidth,imgHeight,flip,imgPop);
      // }

      if (survey == 1 && repeat == 0) {
          imgA.src = $('#999')[0].src;
          // imgB.src = $('#999')[0].src;
          // Draw fixed 45 degree highlight
          // if (left_or_right == 1) {
            ctx2a.beginPath();
            ctx2a.arc(centerX, centerY, radius, curAngle+180+Math.PI*4, curAngle, 1);
            ctx2a.lineWidth = 50;
            ctx2a.strokeStyle = 'white';
            ctx2a.stroke();
            ctx2a.beginPath();
            ctx2a.arc(centerX, centerY, radius, curAngle+180-Math.PI*4, curAngle, 0);
            ctx2a.lineWidth = 50;
            ctx2a.strokeStyle = 'white';
            ctx2a.stroke();
            ctx2a.beginPath();
            ctx2a.arc(centerX, centerY, radius, curAngle + Math.PI/4, curAngle, 1);
            ctx2a.lineWidth = 40;
            ctx2a.strokeStyle = 'black';
            ctx2a.stroke();
            ctx2a.beginPath();
            ctx2a.arc(centerX, centerY, radius, curAngle - Math.PI/4, curAngle, 0);
            ctx2a.lineWidth = 40;
            ctx2a.strokeStyle = 'black';
            ctx2a.stroke();
          // } else {
          //   ctx2b.beginPath();
          //   ctx2b.arc(centerX, centerY, radius, curAngle+180+Math.PI*4, curAngle, 1);
          //   ctx2b.lineWidth = 30;
          //   ctx2b.strokeStyle = 'white';
          //   ctx2b.stroke();
          //   ctx2b.beginPath();
          //   ctx2b.arc(centerX, centerY, radius, curAngle+180-Math.PI*4, curAngle, 0);
          //   ctx2b.lineWidth = 30;
          //   ctx2b.strokeStyle = 'white';
          //   ctx2b.stroke();
          //   ctx2b.beginPath();
          //   ctx2b.arc(centerX, centerY, radius, curAngle + Math.PI/4, curAngle, 1);
          //   ctx2b.lineWidth = 25;
          //   ctx2b.strokeStyle = 'black';
          //   ctx2b.stroke();
          //   ctx2b.beginPath();
          //   ctx2b.arc(centerX, centerY, radius, curAngle - Math.PI/4, curAngle, 0);
          //   ctx2b.lineWidth = 25;
          //   ctx2b.strokeStyle = 'black';
          //   ctx2b.stroke();
          // }
      } else {
        imgA.src = $('#' + trialStruct.itemT_id)[0].src;
        // imgB.src = $('#' + dx.pracimgB[currentFeedTrial])[0].src;
      }

      if (survey == 0) {
        // if (left_or_right == 1) {
          $('#pointer').css({'left': centerX + Math.cos(curAngle)*ringSize-9,
                            'top': centerY + Math.sin(curAngle)*ringSize-9});
        // } else {
        //   $('#pointer').css({'left': centerX+150 + Math.cos(curAngle)*ringSize-10,
        //                     'top': centerY + Math.sin(curAngle)*ringSize-10});
        // }
      } else {
        $('#pointer').hide();
      }

      if (survey == 1) {
        flip == 0? curError = Math.abs(wrap([imgNum-seed[0]])) : curError = Math.abs(wrap([wrap([180-imgNum])-seed[0]]));
      } else {
        // if (left_or_right == 1) {
        flip == 0? curError = Math.abs(wrap([imgNum-trialStruct.itemT_col])) : curError = Math.abs(wrap([wrap([180-imgNum])-trialStruct.itemT_col]));
        flip == 0? ang1 = wrap(imgNum) : ang1 = wrap(180-imgNum)
        // } else {
        //   flip == 0? curError = Math.abs(wrap([imgNum-trialStruct.itemB])) : curError = Math.abs(wrap([wrap([180-imgNum])-trialStruct.itemB]));
        // }
      }
      if (curError > 180) {
          curError = Math.abs(360-curError);
      }

      if (e.isFakeTrigger) { // this code only executes once before anything else happens, e.g. otherwise randrotate would be next trial's randrotate
        trialStruct.startingColor = startingColor;
        trialStruct.randrotate = randrotate;
        trialStruct.flip = flip;
        flip == 0? ringImg.src = $('#ring')[0].src : ringImg.src = $('#ringFlip')[0].src;
        ringctxA.translate(50+500/2, 50+500/2);
        ringctxA.rotate(randrotate*Math.PI/180);
        ringctxA.translate(-50-500/2, -50-500/2);
        ringImg.onload = function() {
          ringctxA.drawImage(ringImg,50,50,500,500);
        }
        ctx2a.onload = function() {
          start(ctx2a,'gray',200, 200, imgWidth, imgHeight, flip, imgA, itemA); //set starting color as grayscale
        }
        start(ctx2a,'gray',200, 200, imgWidth, imgHeight, flip, imgA, itemA);
      }
      if ((currentFeedTrial % trialsPerBlock) == 0) { // needed special code for first item of test phase showing as grayscale, no idea why
        if (tempVar) {
          setTimeout(function() {
            // if (left_or_right == 1) {
              ctx2a.onload = function() {
                start(ctx2a,'gray',200, 200, imgWidth, imgHeight, flip, imgA, itemA); //set starting color as grayscale
              }
              start(ctx2a,'gray',200, 200, imgWidth, imgHeight, flip, imgA, itemA);
            //   start(ctx2a,'gray',175, 175, imgWidth, imgHeight, flip, imgA, itemA);
            //   ctx2b.onload = function() {
            //     start(ctx2b,trialStruct.itemB,50, 50, imgWidth, imgHeight, 0, imgB, itemB); //set starting color as grayscale
            //   }
            //   start(ctx2b,trialStruct.itemB,50, 50, imgWidth, imgHeight, 0, imgB, itemB);
            // } else {
              // ctx2b.onload = function() {
              //   start(ctx2b,'gray',50, 50, imgWidth, imgHeight, flip, imgB, itemB); //set starting color as grayscale
              // }
              // start(ctx2b,'gray',50, 50, imgWidth, imgHeight, flip, imgB, itemB);
            // }
          }, 150);
          tempVar = false;
        }
      }
  });

  $(document).bind('click.curTrial', function(e) {
      if (survey == 1) {
          explicitColor = flip == 0? Math.round(wrap([angleDeg-randrotate])) : Math.round(wrap([180-wrap([angleDeg-randrotate])]));
      } else if (currentPart == 2 && ((new Date()) - startTime) < 500) {
        if (currentFeedTrial % trialsPerBlock != 0) {
          alert('Please take your time when making responses! We will not be able to use your data if it is too noisy! Thanks.');
        }
        tooFast.push(1);
      }

      if (mouseMoved != 0) {
          trialStruct.reportedAngle = Math.round(angleDeg);
          trialStruct.reportedColor = flip == 0? Math.round(wrap([angleDeg-randrotate])) : Math.round(wrap([180-wrap([angleDeg-randrotate])]));
          trialStruct.rt = (new Date()) - startTime;
          trialStruct.trialTimeStart = startTime;
          trialStruct.col_diff = curError;
          $(document).unbind('click.curTrial');
          $(document).unbind('mousemove.curTrial');
          $("#continuousReport").hide();
          if (currentPart == 0 && currentFeedTrial == 0) {
            alert('Cool! Now highlight the smallest range of colors you think includes the true color. This is a confidence range to inform us experimenters about how certain you are of your answer.' +
            ' Click after you\'ve highlighted colors in one circular direction, and then we\'ll do the other direction.')
          }
          if (survey == 0) {
            ShowConfidence(trialStruct,angleDeg);
            $('#popQuiz').hide();
          } else {
            var expConfirm = confirm("Is this your selection? [Cancel] to redo.");
            if (expConfirm == true) {
              Survey3();
            } else {
              ShowContinuousReport({mean: seed[0], type: "color", isPractice: 0, items: 999});
              return;
            }
          }
      }
  });

  e = $.Event('mousemove');
  e.pageX = mouseX;
  e.pageY = mouseY;
  e.isFakeTrigger = true;
  $(document).trigger(e);
}

function ShowConfidence(trialStruct,angleDeg) {
    angleDeg2 = 0;
    startTime = new Date();
    startAngle = angleDeg * Math.PI / 180;
    lastRot = 0;
    noMore = 0;
    diffAng2 = -999;

    /* Confidence report */
    $(document).bind('mousemove.curTrial', function(e) {
        parentOffset = $('#continuousReport').offset();
        relX = e.pageX - parentOffset.left - centerX;
        relY = e.pageY - parentOffset.top - centerY;
        curAngle = Math.atan2(relY,relX);
        angleDeg2 = curAngle / Math.PI * 180.0;
        diffAng2 = wrap([wrap([angleDeg])-wrap([angleDeg2])])>180? wrap([wrap([angleDeg2])-wrap([angleDeg])]) : wrap([wrap([angleDeg])-wrap([angleDeg2])]);
        // if (left_or_right == 1) {
          if (wrap([wrap([angleDeg])-wrap([angleDeg2])])<180 && noMore == 0) { /* conf is counterclockwise */
            ctx2a.beginPath();
            ctx2a.arc(centerX, centerY, radius, startAngle - Math.PI, curAngle, 1);
            ctx2a.lineWidth = 50;
            ctx2a.strokeStyle = 'white';
            ctx2a.stroke();
            ctx2a.beginPath();
            ctx2a.arc(centerX, centerY, radius, startAngle, curAngle, 1);
            ctx2a.lineWidth = 40;
            ctx2a.strokeStyle = 'black';
            ctx2a.stroke();
            ctx2a.beginPath();
            ctx2a.arc(centerX, centerY, radius, startAngle + Math.PI, curAngle, 0);
            ctx2a.lineWidth = 50;
            ctx2a.strokeStyle = 'white';
            ctx2a.stroke();
            lastRot = 1; lastRotMat.push(lastRot);
          } else if (wrap([wrap([angleDeg])-wrap([angleDeg2])])>180 && noMore == 0) { /* conf is clockwise */
            ctx2a.beginPath();
            ctx2a.arc(centerX, centerY, radius, startAngle + Math.PI, curAngle, 0);
            ctx2a.lineWidth = 50;
            ctx2a.strokeStyle = 'white';
            ctx2a.stroke();
            ctx2a.beginPath();
            ctx2a.arc(centerX, centerY, radius, startAngle, curAngle, 0);
            ctx2a.lineWidth = 40;
            ctx2a.strokeStyle = 'black';
            ctx2a.stroke();
            ctx2a.beginPath();
            ctx2a.arc(centerX, centerY, radius, startAngle - Math.PI, curAngle, 1);
            ctx2a.lineWidth = 50;
            ctx2a.strokeStyle = 'white';
            ctx2a.stroke();
            lastRot = 0; lastRotMat.push(lastRot);
          }
        // } else {
        //   if (wrap([wrap([angleDeg])-wrap([angleDeg2])])<180 && noMore == 0) { /* conf is counterclockwise */
        //     ctx2b.beginPath();
        //     ctx2b.arc(centerX, centerY, radius, startAngle - Math.PI, curAngle, 1);
        //     ctx2b.lineWidth = 30;
        //     ctx2b.strokeStyle = 'white';
        //     ctx2b.stroke();
        //     ctx2b.beginPath();
        //     ctx2b.arc(centerX, centerY, radius, startAngle, curAngle, 1);
        //     ctx2b.lineWidth = 25;
        //     ctx2b.strokeStyle = 'black';
        //     ctx2b.stroke();
        //     ctx2b.beginPath();
        //     ctx2b.arc(centerX, centerY, radius, startAngle + Math.PI, curAngle, 0);
        //     ctx2b.lineWidth = 30;
        //     ctx2b.strokeStyle = 'white';
        //     ctx2b.stroke();
        //     lastRot = 1; lastRotMat.push(lastRot);
        //   } else if (wrap([wrap([angleDeg])-wrap([angleDeg2])])>180 && noMore == 0) { /* conf is clockwise */
        //     ctx2b.beginPath();
        //     ctx2b.arc(centerX, centerY, radius, startAngle + Math.PI, curAngle, 0);
        //     ctx2b.lineWidth = 30;
        //     ctx2b.strokeStyle = 'white';
        //     ctx2b.stroke();
        //     ctx2b.beginPath();
        //     ctx2b.arc(centerX, centerY, radius, startAngle, curAngle, 0);
        //     ctx2b.lineWidth = 25;
        //     ctx2b.strokeStyle = 'black';
        //     ctx2b.stroke();
        //     ctx2b.beginPath();
        //     ctx2b.arc(centerX, centerY, radius, startAngle - Math.PI, curAngle, 1);
        //     ctx2b.lineWidth = 30;
        //     ctx2b.strokeStyle = 'white';
        //     ctx2b.stroke();
        //     lastRot = 0; lastRotMat.push(lastRot);
        //   }
        // }
    });

    $(document).bind('click.curTrial', function(e) {
      if (currentPart == 0 && currentFeedTrial == 0 && noMore == 0) {
        if (lastRot == 0) {
          alert('Now finish your highlighting in the other circular direction. ' +
          ' Since you went clockwise so far, finish by clicking counterclockwise from your original best guess.')
        } else {
          alert('Now finish your highlighting in the other circular direction. ' +
          ' Since you went counterclockwise so far, finish by clicking clockwise from your original best guess.')
        }
      }
      trialStruct.rt2 = (new Date()) - startTime;
      ShowConfidence2(trialStruct,angleDeg,angleDeg2,diffAng2,lastRot);
      noMore = 1;
    })

    $("#continuousReport").show();
    e = $.Event('mousemove');
    e.pageX = mouseX;
    e.pageY = mouseY;
    e.isFakeTrigger = true;
    $(document).trigger(e);
}

function ShowConfidence2 (trialStruct,angleDeg,angleDeg2,diffAng2,lastRot) {
  angleDeg3 = 0;
  startTime = new Date();
  startAngle = angleDeg * Math.PI / 180;
  startAngle2 = angleDeg2 * Math.PI / 180;
  LastLock = 0;

  /* Confidence report */
  $(document).bind('mousemove.curTrial', function(e) {
      parentOffset = $('#continuousReport').offset();
      relX = e.pageX - parentOffset.left - centerX;
      relY = e.pageY - parentOffset.top - centerY;
      curAngle = Math.atan2(relY,relX);
      angleDeg3 = curAngle / Math.PI * 180.0;
      diffAng3 = wrap([wrap([angleDeg])-wrap([angleDeg3])])>180? wrap([wrap([angleDeg3])-wrap([angleDeg])]) : wrap([wrap([angleDeg])-wrap([angleDeg3])]);
      console.log(LastLock)
      // if (left_or_right == 1) {
        if (wrap([wrap([angleDeg])-wrap([angleDeg3])])<180+(180-diffAng2) && lastRot == 0) { /* conf is counterclockwise */
          if (wrap([wrap([angleDeg2])-wrap([angleDeg3])])<180) { LastLock = 0; } else { LastLock = 1; }
          imgNum3 = Math.round(wrap([(curAngle / Math.PI * 180.0)-randrotate]));
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, startAngle, curAngle, 1);
          ctx2a.lineWidth = 40;
          ctx2a.strokeStyle = 'black';
          ctx2a.stroke();
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, startAngle + diffAng2*Math.PI/180, curAngle, 0);
          ctx2a.lineWidth = 50;
          ctx2a.strokeStyle = 'white';
          ctx2a.stroke();
        } else if (wrap([wrap([angleDeg])-wrap([angleDeg3])])>180-(180-diffAng2) && lastRot == 1) { /* conf is clockwise */
          if (wrap([wrap([angleDeg2])-wrap([angleDeg3])])<180) { LastLock = 1; } else { LastLock = 0; }
          imgNum3 = Math.round(wrap([(curAngle / Math.PI * 180.0)-randrotate]));
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, startAngle, curAngle, 0);
          ctx2a.lineWidth = 40;
          ctx2a.strokeStyle = 'black';
          ctx2a.stroke();
          ctx2a.beginPath();
          ctx2a.arc(centerX, centerY, radius, startAngle - diffAng2*Math.PI/180, curAngle, 1);
          ctx2a.lineWidth = 50;
          ctx2a.strokeStyle = 'white';
          ctx2a.stroke();
        }
      // } else {
      //   if (wrap([wrap([angleDeg])-wrap([angleDeg3])])<180+(180-diffAng2) && lastRot == 0) { /* conf is counterclockwise */
      //     ctx2b.beginPath();
      //     ctx2b.arc(centerX, centerY, radius, startAngle, curAngle, 1);
      //     ctx2b.lineWidth = 25;
      //     ctx2b.strokeStyle = 'black';
      //     ctx2b.stroke();
      //     ctx2b.beginPath();
      //     ctx2b.arc(centerX, centerY, radius, startAngle + diffAng2*Math.PI/180, curAngle, 0);
      //     ctx2b.lineWidth = 30;
      //     ctx2b.strokeStyle = 'white';
      //     ctx2b.stroke();
      //   } else if (wrap([wrap([angleDeg])-wrap([angleDeg3])])>180-(180-diffAng2) && lastRot == 1) { /* conf is clockwise */
      //     ctx2b.beginPath();
      //     ctx2b.arc(centerX, centerY, radius, startAngle, curAngle, 0);
      //     ctx2b.lineWidth = 25;
      //     ctx2b.strokeStyle = 'black';
      //     ctx2b.stroke();
      //     ctx2b.beginPath();
      //     ctx2b.arc(centerX, centerY, radius, startAngle - diffAng2*Math.PI/180, curAngle, 1);
      //     ctx2b.lineWidth = 30;
      //     ctx2b.strokeStyle = 'white';
      //     ctx2b.stroke();
      //   }
      // }
    });

  $(document).bind('click.curTrial', function(e) {
    ctx2a.clearRect(0,0,600,600); // erases the black highlighting
    // ctx2b.clearRect(0,0,600,600); // erases the black highlighting

    pointsA = (curError - 45) / (0 - 45);
    if (pointsA < 0) { pointsA = 0; }

    encap = 0;
    imgNum2 = Math.round(wrap([angleDeg2-randrotate]));
    flip == 0? ang2 = wrap(imgNum2) : ang2 = wrap(180-imgNum2)
    flip == 0? ang3 = wrap(imgNum3) : ang3 = wrap(180-imgNum3)

    if (lastRot==0 && ang1 != ang2) { //clockwise first
      highlightedColors = counter(ang1,ang2);
    } else {
      highlightedColors = counter(ang2,ang1);
    }
    if (lastRot==0 && ang2 != ang3 && LastLock == 1) { //clockwise first
      highlightedColors = highlightedColors.concat(counter(ang3,ang1))
    } else {
      highlightedColors = highlightedColors.concat(counter(ang1,ang3))
    }
    highlightedColors = wrap(highlightedColors);

    if (highlightedColors.includes(wrap(trialStruct.itemT_col))) { encap = 1 }
    if (angleDeg2 == angleDeg3 & curError != 0) { encap = 0 }

    var UniqueLen = highlightedColors.filter(function(val, i, arr) {
      return arr.indexOf(val) === i; }).length;
    pointsB = (UniqueLen - 360) / (1 - 360);
    if (pointsB < 0 || encap == 0) { pointsB = 0; }

    pointsSum = pointsA + pointsB; pointsSum = pointsSum.toFixed(2);
    points = points + (pointsSum*.01);

    if (pointsSum >= 1.50) {
        feedText = 'Amazing!<br>(+ ' + pointsSum + '&#x00A2)';
    } else if (pointsSum >= 1.00) {
        feedText = 'Good!<br>(+ ' + pointsSum + '&#x00A2)';
    } else {
        feedText = '(+ ' + pointsSum + '&#x00A2)';
    }
    document.getElementById("fixation").innerHTML = feedText;
    $("#continuousReport").hide();
    $(document).unbind('click.curTrial');
    $(document).unbind('mousemove.curTrial');
    trialStruct.rt3 = (new Date()) - startTime;
    trialStruct.conf2 = diffAng2;
    trialStruct.conf3 = diffAng3;

    if (trialStruct.isPractice) {
        $('#feedbackError').html("Your error was: " + Math.round(curError) + " deg (aim for less than 50 deg.!)<br><br>Click to continue.");

        // if (left_or_right == 1) {
          imgNum = Math.round(wrap([angleDeg-randrotate]));
          start(ctx3,imgNum,80,100, 200, 200, flip, imgA, itemA);
          imgNum = flip == 0? Math.round(trialStruct.itemT_col) : Math.round(wrap([180-trialStruct.itemT_col]));
          start(ctx4,imgNum,40,100, 200, 200, flip, imgA, itemA);
        // } else {
        //   imgNum = Math.round(wrap([angleDeg-randrotate]));
        //   start(ctx3,imgNum,80,100, 200, 200, flip, imgB, itemB);
        //   imgNum = flip == 0? Math.round(trialStruct.itemB) : Math.round(wrap([180-trialStruct.itemB]));
        //   start(ctx4,imgNum,40,100, 200, 200, flip, imgB, itemB);
        // }

        // imgA.src = $('#' + trialStruct.itemT_id)[0].src;


        flip = Math.round(Math.random());
        randrotate = Math.floor(Math.random()*360);

        $('#feedback').show();
        $(document).bind('click.feedback', function(e) {
            $('#feedback').hide();
            NextTrial();
            document.getElementById("fixation").innerHTML = '+';
            $(document).unbind('click.feedback');
        });
    } else {
        $('#showTrial').show();
        if (repeat == 1) {
            imgPop.src = $('#' + trialStruct.itemT_id)[0].src;
            numRepeats++;
        } else if (currentFeedTrial < numTrialsPerPart[1]-1) {
            imgA.src = $('#' + r_totalTrials[currentPart][currentFeedTrial+1].itemT_id)[0].src;
            // imgB.src = $('#' + r_totalTrials[currentPart][currentFeedTrial+1].itemB)[0].src;
        } else if (currentFeedTrial>=numTrialsPerPart[currentPart]-1) { /* this is to prepare the gray square in explicit test */
            imgA.src = $('#999')[0].src;
            // imgB.src = $('#999')[0].src;
        }

        flip = 0; //Math.round(Math.random());
        randrotate = Math.floor(Math.random()*360);

        setTimeout(function() {
            NextTrial();
            document.getElementById("fixation").innerHTML = '+';
        }, feedbackTime);
    }
  });
}

function Survey() {
  if (document.getElementById("surveyresponseRand").checked) {
      radioResp = 1;
  } else if (document.getElementById("surveyresponsePref").checked) {
      radioResp = 2;
  }
  //proceed only if they picked one of two options
  if (radioResp > 0) {
      $('#instructions').hide();

      // Now they have answered our multiple-coice question
      $("#survey2").hide();
      survey = 1;

      /*Preload color wheel, first practice trial will have randrotate=0 and flip=0*/
      // if (left_or_right == 1) {
        ringctxA.restore();
        ringctxA.drawImage(ringImg,50,50,500,500);
        ringctxA.save();
      // } else {
      //   ringctxB.restore();
      //   ringctxB.drawImage(ringImg,0,0,280,280);
      //   ringctxB.save();
      // }

      if (radioResp == 1) {
        document.getElementById("underText").innerHTML = "We actually did manipulate what colors were presented. Specifically, 40% of objects were sampled from one quarter of the color wheel (90 degree region). Please select the range of colors you think matches our preferential color sampling.";
      } else if (radioResp == 2) {
        document.getElementById("underText").innerHTML = "Yes, we did manipulate what colors were presented. Specifically, 40% of objects were sampled from one quarter of the color wheel (90 degree region). Please select the range of colors you think matches our preferential color sampling.";
      }

      ShowContinuousReport({mean: seed[0], type: "color", isPractice: 0, items: 999});

      alert(document.getElementById("underText").innerHTML);
      mouseMoved = 0;
  } else {
      alert('Please select an option.');
  }
}

function Survey1() {
  $('#survey1').show();
}

function Survey2() {
  $('#survey1').hide();
  $("#survey2").show();
}

function Survey3() {
  $('#survey3').show();
}

/* Done with the experiment; wait for comments and for them to hit Save */
function Done() {
  //proceed only if they picked an option for survey3
  // if (document.querySelector('input[name="likertz"]:checked').value > 0) {
      // likertAns = document.querySelector('input[name="likertz"]:checked').value;
      $("#survey1").hide();
      $('#done').show();
      let cashpoints = points + basepay;
      document.getElementById("cashPrize").innerHTML = "Total earnings: $" + cashpoints.toFixed(2);
      points = points.toFixed(2); //round to 2 decimal places
  /* } else {
      alert('Please select an option.');
  } */
}

/* Choose what to save and then put it on the server */
function SaveData() {
  $('#done').children().hide();
  $('#saving').show();
  $('#assignmentId').val(GetAssignmentId());
  const newDate = new Date();
  const d = {
    "WORKERID": WORKERID,
    "ASSIGNMENTID": ASSIGNMENTID,
    "curTime": newDate.today() + " @ " + newDate.timeNow(),
    "startExpTime": startExpTime,
    "endExpTime": newDate,
    "totalExpTime": newDate - startExpTime,
    "userAgent": navigator.userAgent,
    "windowWidth": $(window).width(),
    "windowHeight": $(window).height(),
    "screenWidth": screen.width,
    "screenHeight": screen.height,
    "comments": $('#comments').val(),
    "strategy": $('#strategy').val(),
    "pracTrials": r_totalTrials[0],
    "studyTrials": r_totalTrials[1],
    "testTrials": r_totalTrials[2],
    "radioResponse": radioResp,
    "explicitColor": explicitColor,
    "LikertAns": likertAns,
    "Bonus": points,
    "Seeds": seed,
    "StudyOrder": [dx.testimgA,dx.testimgB],
    "leftColor": dx.imgAcolor,
    "rightColor": dx.imgBcolor,
    "colorChange": dx.sign,
    "firstConfDir": lastRotMat,
    "tooFastCount": tooFast,
    "Age": age,
    "Sex": sex
  };

    /* save to Firebase server */
    const blob = new Blob([JSON.stringify(d)], {type: "application/json"});
    const storageRef = firebase.storage().ref('data/' + WORKERID + '.json');
    storageRef.put(blob);

    document.getElementById("saving").innerHTML = "Submitting HIT...";

    // submit HIT after waiting a few seconds to make sure data got sent
    setTimeout(function(){ document.forms[0].submit(); }, 3000);
}

function start(context,deg,initX,initY,imgWidth,imgHeight,flip,image,itemID) {
    flip==0? colors=origColors : colors=flippedColors;
    let col = [127.5,127.5,127.5];
    if (deg != 'gray') {
        deg=(deg>=360)?deg-360:deg;
        deg=(deg<0)?deg+360:deg;
        col = colors[deg];
    }
    if (context == ctx3 || context == ctx4) {
      context.drawImage(image, initX, initY, imgWidth, imgHeight);
      recolor(context,Math.round(col[0]),Math.round(col[1]),Math.round(col[2]),initX,initY,itemID);
    } else {
      image.onload = function() {
        context.drawImage(image, initX, initY, imgWidth, imgHeight);
        recolor(context,Math.round(col[0]),Math.round(col[1]),Math.round(col[2]),initX,initY,itemID);
      }
      context.drawImage(image, initX, initY, imgWidth, imgHeight);
      recolor(context,Math.round(col[0]),Math.round(col[1]),Math.round(col[2]),initX,initY,itemID);
    }
}
function recolor(context,newR,newG,newB,initX,initY,itemID) {
    imgData = context.getImageData(initX, initY, itemID.width, itemID.height);
    let data = imgData.data;
    for (let i = 0; i < data.length; i += 4) {
        let red = data[i];
        let green = data[i + 1];
        let blue = data[i + 2];
        if (red > 5 && blue < 200) {
            data[i] = newR;
            data[i + 1] = newG;
            data[i + 2] = newB;
        }
    }
    context.putImageData(imgData, initX, initY);
}

/* Make sure number is between 0 and 360: */
function wrap(v) {
  for (let i=0; i<v.length; i++) {
    if (v[i]>360) { v[i]-=360; }
    if (v[i]<0) { v[i]+=360; }
  }
  if (v.length == undefined) {
    if (v>360) { v-=360; }
    if (v<0) { v+=360; }
    v = parseInt(v); // v becomes integer and not array
  }
  return v;
}

function wrapDiff(input,comparison) { // deg difference in color space
  if (input < comparison) {
    a = input; b = comparison
  } else {
    a = comparison; b = input
  }
  degree = Math.abs(a-b);
  if (degree > 180) {
    degree = Math.abs(a-(b-360))
  }
  if (degree < -180) {
    degree = Math.abs(a-(b+360))
  }
  return wrap(degree);
}

function ImagesReady() { // check that all images are loaded before starting expt
    setTimeout(function(){ // dont start the check at the same time as the document is loading
    var totImages = 0; var readyLoad = 0;
    while (readyLoad == 0) {
      for (let k=101; k<700; k++) {
        if ($('#'+k)[0] != null) {
          if ($('#'+k)[0].complete) {
          totImages++; }
        }
      }
      if (totImages >= 599) { readyLoad = 1; } else { totImages = 0; }
    }
    $('#loading').hide();
    $('a#TextButton').show();
    }, 3000);
};

function isIE() {
  ua = navigator.userAgent;
  var is_ie = ua.indexOf("MSIE ") > -1 || ua.indexOf("Trident/") > -1;
  return is_ie;
}

$(function() { // check if Safari or IE
  if (!!navigator.userAgent.match(/Version\/[\d\.]+.*Safari/)) { // if Safari
    $('body').html('Unfortunately this HIT does not work in Safari. It works in Chrome, Firefox, or Opera. Sorry!');
  } else if (isIE()) { // if IE
    $('body').html('Unfortunately this HIT does not work in Internet Explorer. It works in Chrome, Firefox, or Opera. Sorry!');
  }
});


</script>
</body></html>
