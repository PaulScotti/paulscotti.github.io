
<!-- originally modified from Tim Brady url=http://timbrady.org/turk/ensembleindivdiff/e9/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<script src="./Gist_files/jquery.min.js"></script>
<script src="./Gist_files/seedrandom.js"></script>
<script src="./Gist_files/colors.js"></script>
<script src="./Gist_files/TimTurkTools.js"></script>
<link rel="stylesheet" type="text/css" href="./Gist_files/contReport.css">
<link rel="stylesheet" type="text/css" href="./Gist_files/showTrials.css">
<link rel="stylesheet" type="text/css" href="./Gist_files/experiment.css">
<script>
/* Options: */
var displayTime = 1000;
var isiTime = 1000;
var numTrialsPerPart = [3, 60];

/* Choose which to start with before we seed the random number
    generator so it really is random across subjects */
var startWithGist = Math.random()<0.50;

var practiceTriTrials = [];
var triTrials = [];
var totalTrials = [];

/* Pointers for where we are in the experiment: */
var currentTrial = -1;
var currentPart = 0;
var setTo;
var setItem;

/* Generate trials: Do it the same for each subject by seeding the
   random number generator the same every time. */
function GenerateTrials() {
  Math.seedrandom('penguinsarecute');
  for (var i=0; i<numTrialsPerPart[2]/3; i++) {
    var curMean = Math.floor(Math.random()*360);
    for (var j=0; j<3; j++) {
      triTrials.push({'mean': curMean,
                      'type': 'color',
                      'isPractice': 0,
                      'items': wrap([curMean-15, curMean-5, curMean+5, curMean+15])});
    }
  }
  triTrials = Shuffle(triTrials);
 }

/* Start the experiment. Show the trials for either faces or emotions
   first (at random) */
function StartExperiment() {
  if (IsOnTurk() && IsTurkPreview()) {
    alert("Please accept the HIT before continuing.");
    return false;
  }
  GenerateTrials();
  ChangeToTri();
    totalTrials = [practiceTriTrials, triTrials];
    setTo = [ChangeToTri, ChangeToTri];
    setItem = [SetTri, setTri];
  $('#instructions').hide();
  NextTrial();
}

/* Show the next trial or show the done screen if they are finished: */
function NextTrial() {
  currentTrial++;
  if (currentTrial>=numTrialsPerPart[currentPart]) {
    if (currentPart==totalTrials.length-1) {
      Done();
      return;
    } else {
      currentTrial = 0;
      currentPart++;
      setTo[currentPart]();
      if (currentPart == 2) {
        alert("Okay, time for the real experiment. You won't get feedback about how you are doing anymore. Please do your best!");
      }
    }
  }
  ShowTrial(totalTrials[currentPart][currentTrial], setItem[currentPart]);
}

/* Basic trial structure: Wait for click; then show the stimuli for this trial;
  then delay for fixed ISI; then call ShowContinuousReport */
function ShowTrial(trialStruct, howToSet) {
  for (var i=0; i<4; i++) {
    howToSet('#item' + (i+1), trialStruct.items[i]);
  }
  $('#allItems').css('margin-top', -1000);
  $('#showTrial').show();
  if (currentPart < 2) {
    $('#pressKey').html('<u><font color=navy>Practice for Part ' + (currentPart+1) + ' of 2</font></u><br><br>Trial ' + (currentTrial+1) + ' of ' + numTrialsPerPart[currentPart] + ' (in this part)<br><br>Click anywhere to start this trial.');
  }  else {
    $('#pressKey').html('<u>Part ' + (currentPart-1) + ' of 2</u><br><br>Trial ' + (currentTrial+1) + ' of ' + numTrialsPerPart[currentPart] + ' (in this part)<br><br>Click anywhere to start this trial.');
  }
  $('#pressKey').show();
  $(document).bind('click.startTrial', function(e) {
      $(document).unbind('click.startTrial');
      setTimeout(function() {
        $('#allItems').css('margin-top', 0);
        setTimeout(function() {
            $('#allItems').css('margin-top', -1000);
            setTimeout(function() {
              $('#showTrial').hide();
              ShowContinuousReport(trialStruct, howToSet);
            }, isiTime);
        }, displayTime);
      }, 500);
      $('#pressKey').hide();
   });
}

/* Always track the mouse */
var mouseX, mouseY;
$(function() {
  $(document).bind('mousemove.overall', function(e) {
    mouseX = e.pageX;
    mouseY = e.pageY;
  });
});

/* Handle continuous report for either emotions or faces by using a single
   image with 360 images side-by-side in it, in the style of a css sprite */
function ShowContinuousReport(trialStruct, howToSet) {
  var centerX = 300, centerY = 300;
  var ringSize = 250;
  var angleDeg = 0;
  var curError = 360;
  var startTime = new Date();

	$(document).bind('mousemove.curTrial', function(e) {
		var parentOffset = $('#continuousReport').offset();
   	var relX = e.pageX - parentOffset.left - centerX;
  	var relY = e.pageY - parentOffset.top - centerY;
		var curAngle = Math.atan2(relY,relX);
		angleDeg = curAngle / Math.PI * 180.0;
    angleDeg = (angleDeg < 0) ? angleDeg+360:angleDeg;
		var imgNum = Math.round(angleDeg);
    howToSet('#continuousStimulus', imgNum);
		$('#pointer').css({'left': centerX + Math.cos(curAngle)*ringSize-9,
                       'top': centerY + Math.sin(curAngle)*ringSize-9});
    if (trialStruct.isPractice) {
        curError = Math.min(Math.abs(angleDeg-trialStruct.mean),
          Math.abs((angleDeg+360)-trialStruct.mean),
          Math.abs((angleDeg-360)-trialStruct.mean));
    }
    if (e.isFakeTrigger) {
      trialStruct.startedAngle = Math.round(angleDeg);
    }
	});

  $(document).bind('click.curTrial', function(e) {
    trialStruct.reportedAngle = Math.round(angleDeg);
    trialStruct.rt = (new Date()) - startTime;
    $(document).unbind('click.curTrial');
    $(document).unbind('mousemove.curTrial');
    $("#continuousReport").hide();
    if (trialStruct.isPractice) {
      $('#feedbackError').html("Your error was: " + Math.round(curError) + " deg (aim for less than 20 deg.!)<br><br>Click to continue.");
      var imgNum = Math.round(angleDeg);
      howToSet('#feedbackReported', imgNum);
      imgNum = Math.round(trialStruct.mean);
      howToSet('#feedbackCorrect', imgNum);
      $('#feedback').show();
      $(document).bind('click.feedback', function(e) {
        $('#feedback').hide();
        NextTrial();
        $(document).unbind('click.feedback');
      });
    } else {
      NextTrial();
     }
	});

  $("#continuousReport").show();
  e = $.Event('mousemove');
  e.pageX = mouseX;
  e.pageY = mouseY;
  e.isFakeTrigger = true;
  $(document).trigger(e);
}

/* Done with the experiment; wait for comments and for them to hit Save */
function Done() {
  $('#done').show();
}

/* Save the data to the server (choose what to save) */
function SaveData() {
  $('#done').children().hide();
  $('#saving').show();
  $('#assignmentId').val(GetAssignmentId());
  var newDate = new Date();
  var curID = (IsOnTurk())? GetAssignmentId() : prompt("Doesn't look like you " +
  "are on Turk, so you're probably testing. Enter an ID to save your data with:", "id");
  d = {
    "curID": curID,
    "curTime": newDate.today() + " @ " + newDate.timeNow(),
    "userAgent": navigator.userAgent,
    "windowWidth": $(window).width(),
    "windowHeight": $(window).height(),
    "screenWidth": screen.width,
    "screenHeight": screen.height,
    "comments": $('#comments').val(),
    "totalTrials": totalTrials
  };
  SendToServer(curID, d);
}

/* Send the data to the server as JSON: */
function SendToServer(id, curData) {
  var dataToServer = {
    'id': id,
    'experimentName': 'EnsembleIndivDifference9',
    'curData': JSON.stringify(curData)
  };
  $.post("https://timbrady.org/turk/save.pl",
    dataToServer,
    function(data) {
      document.forms[0].submit();
    }
  ).fail(function(data) {
      document.forms[0].submit();
  });
}

/* Helper functions to change the stimuli between emotions and faces: */
function ChangeToTri() {
  $('.itemDiv').addClass("itemDivTri").addClass("arrowRight");
  $('#continuousStimulus').addClass("continuousStimulusTri").addClass("arrowRight");
	$('#feedbackCorrect').addClass("feedbackCorrectTri").addClass("arrowRight");
	$('#feedbackReported').addClass("feedbackReportedTri").addClass("arrowRight");
	$('#item1').addClass("item1Tri");
	$('#item2').addClass("item2Tri");
	$('#item3').addClass("item3Tri");
	$('#item4').addClass("item4Tri").removeClass("item4Emotion");
  $('.itemDiv').css({'background-image': 'none'});
  $('#item1').css({'background-image': 'none'});
  $('#item2').css({'background-image': 'none'});
  $('#item3').css({'background-image': 'none'});
  $('#item4').css({'background-image': 'none'});
  $('#feedbackCorrect').css({'background-image': 'none'});
  $('#feedbackReported').css({'background-image': 'none'});
  $('#continuousStimulus').css({'background-image': 'none'});

  $('#continuousReport').css({'background-color': '#DDDDDD'});
  $('#showTrial').css({'background-color': '#DDDDDD'});
}

function SetTri(id, deg) {
  deg=(deg>=360)?deg-360:deg;
  deg=(deg<0)?deg+360:deg;
  var col=colors.colors[deg];
  $(id).css({'background-color':'rgb('+Math.round(col[0])+','+Math.round(col[1])+','+Math.round(col[2])+')'});
}

/* Make sure all numbers in an array are between 0 and 360: */
function wrap(v) {
  for (var i=0; i<v.length; i++) {
    if (v[i]>360) { v[i]-=360; }
    if (v[i]<0) { v[i]+=360; }
  }
  return v;
}

$(window).load(function () {
  $('#startExperimentButton').show();
  $('#loading').hide();
});

$(function() {
  if (navigator.userAgent.indexOf('MSIE') != -1) {
    $('body').html('Unfortunately this HIT does not work in IE. It works in Chrome, Firefox or Safari. Sorry!');
  }
});

</script>
<style>
.arrowRight {
  width: 130px;
  height: 130px;
  -webkit-border-radius: 65px;
  -moz-border-radius: 65px;
  border-radius: 65px;
  background-image: none;
  background-color: black;
}

.continuousStimulusTri {
	margin-left: 235px;
  margin-top:  235px;
}

.itemDivTri {
  position: absolute;
	background-position:0px 0px;
}

.item1Tri {
  top: 85px;
  left: 85px;
}
.item2Tri {
  top: 85px;
  left: 385px;
}
.item3Tri {
  top: 385px;
  left: 85px;
}
.item4Tri {
  top: 385px;
  left: 385px;
}

.feedbackReportedTri {
  position: absolute;
  top: 120px;
  left: 80px;
}

.feedbackCorrectTri {
  position: absolute;
  top: 120px;
  right: 80px;
}

</style>
</head>
<body style="">

<!-- Instructions: -->
<div id="instructions">
  <p>In this HIT, you will have to perform a change detection task involving colored circles. It should take about 15-20 minutes total. </p>
  <p>Every trial you will see several circles, like this:</p>
  <p align="center"><img src="./Gist_files/instrucTriangles.png" width="400" border="1"></p>
  <p>Notice how the color of the circles are all slightly different. These circles will be shown briefly, and then disappear, and then be shown again. You will be asked to <strong>report whether any circle changed color.</strong> To do so, you'll use the arrow keys (up left right) to select which color changed color. Alternatively, if no color changed, press the down arrow key.</p>
  <p>You will then indicate how confident you are in your response by using the number keys. Please respond on a scale of 1 (uncertain) to 5 (certain).</p>
  <p>The amount of time the colors stay displayed after they have reappeared is variable, meaning that on some trials the color will only reappear for a brief moment. The task is always the same no matter how long the circles appear on the screen.</p>
    <p>To start off with, we'll give you <strong>30 practice trials</strong>. <strong>During the practice trials, you'll get feedback on how far off you are.</strong></p>
  <p style="text-align: center"><a href="javascript:StartExperiment()" id="startExperimentButton" style="display: inline;">Start Experiment</a><span id="loading" style="display: none;">Images still loading. Please wait. &nbsp; &nbsp; <img src="./Gist_files/spinner.gif" style="width: 30px; height: 30px"></span></p>
  <!-- Consent statement at bottom: -->
  <div id="consentDiv"><p><u>Consent to Participate in Research:</u></p> <p>By answering the following questions, you are participating in a study being performed by cognitive scientists in the Harvard University Psychology Department.  The purpose of this research is to examine human visual performance.</p><p>By participating you are confirming that you are over 18 years of age and have normal or corrected-to-normal vision.</p><p>If you have questions about this research, or if you would like to receive a report of this research when it is completed please contact Timothy Brady at tbrady@wjh.harvard.edu.</p><p>Your participation in this research is completely voluntary.  If you choose to participate, you may change your mind and leave the study at any time.  Refusal to participate or stopping your participation will involve no penalty or loss of benefits to which you are otherwise entitled.</p><p>You may decline to answer any or all of the following questions. Your anonymity is assured; the researchers who have requested your participation will not receive any personal information about you. </p><p>For questions, concerns, or complaints that are not being addressed by the researcher, or research-related harm contact:  Committee on the Use of Human Subjects in Research at Harvard University, 1414 Massachusetts Avenue, Second Floor, Cambridge, MA  02138. Phone: 617-496-CUHS (2847).  Email: cuhs@fas.harvard.edu</p><p>By continuing, you are confirming that you understand these instructions and conditions of participation.</p></div>
</div>

<!-- Start form here to capture comments -->
<form id="turkSubmit" action="https://www.mturk.com/mturk/externalSubmit" method="get">
<input type="hidden" name="assignmentId" id="assignmentId" value="">
<input type="hidden" name="assignmentId" id="assignmentId" value="">
<input type="submit" value="Submit" name="submitButton" id="submitButton" style="display: none">
<!-- submit to turk
 https://workersandbox.mturk.com/mturk/externalSubmit
https://www.mturk.com/mturk/externalSubmit
-->


<!-- Screen for collecting comments when they are done: -->
<div id="done"><div id="doneText">Done! Thanks!<br><br>Any comments for us? (Was it fun? Any technical difficulties?)<br><br>
<textarea name="comments" id="comments" style="width: 300px; height: 200px"></textarea><br><br>
<a href="javascript:SaveData()" id="timSubmit">Submit</a>
</div><div id="saving">Saving . . .</div></div>

<!-- Basic structure for a trial: -->
<div id="showTrial"><div id="allItems"><div id="item1" class="itemDiv item1Tri"></div><div id="item2" class="itemDiv item2Tri"></div><div id="item3" class="itemDiv item3Tri"></div><div id="item4" class="itemDiv item4Tri"></div></div><div id="fixation">+</div><div id="pressKey">Click anywhere to start this trial.</div></div>

<!-- Structure for continuous report after the trial: -->
<div id="continuousReport"><div id="continuousStimulus"></div><div id="ring"></div><div id="pointer">&nbsp;</div></div>

<!-- feedback -->
<div id="feedback"><div id="feedbackReportedText">You choose:</div><div id="feedbackReported"></div><div id="feedbackCorrectText">Correct answer:</div><div id="feedbackCorrect"></div><div id="feedbackError">Your error was: 10 deg (aim for less than 10 degrees!).<br>Click to continue.</div></div>

    
<script type="text/javascript">( function(){ window.SIG_EXT = {}; } )()</script></body></html>
